{"ast":null,"code":"var _jsxFileName = \"F:\\\\kelany\\\\src\\\\pages\\\\Tashkeen.jsx\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport React, { useEffect, useMemo, useState, useCallback } from 'react';\nimport { supabase } from '../supabaseClient';\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nfunction StatusStrip({\n  status\n}) {\n  const cls = status === 'available' ? 'bg-status-available' : status === 'reserved' ? 'bg-status-reserved' : status === 'occupied' ? 'bg-status-occupied' : status === 'maintenance' ? 'bg-status-maintenance' : 'bg-gray-300';\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: `h-1 ${cls}`\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 9,\n    columnNumber: 10\n  }, this);\n}\n_c = StatusStrip;\nfunction CleanBadge({\n  value\n}) {\n  const map = {\n    clean: {\n      text: 'نظيفة',\n      cls: 'bg-green-100 text-green-700'\n    },\n    in_cleaning: {\n      text: 'جاري تنظيف',\n      cls: 'bg-amber-100 text-amber-700'\n    },\n    needs_cleaning: {\n      text: 'تحتاج نظافة',\n      cls: 'bg-red-100 text-red-700'\n    }\n  };\n  const v = map[value] || map.clean;\n  return /*#__PURE__*/_jsxDEV(\"span\", {\n    className: `text-xs px-2 py-1 rounded ${v.cls}`,\n    children: v.text\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 19,\n    columnNumber: 10\n  }, this);\n}\n_c2 = CleanBadge;\nfunction RoomTile({\n  room,\n  resv,\n  date,\n  onDropReservation\n}) {\n  _s();\n  const capacity = Number(room.max_guests || room.capacity || 0);\n  const [beds, setBeds] = useState([]);\n  const [loadingBeds, setLoadingBeds] = useState(false);\n  const [resGuests, setResGuests] = useState([]);\n  const [loadingGuests, setLoadingGuests] = useState(false);\n  const [selectedGuestId, setSelectedGuestId] = useState(null);\n  const [guestSearch, setGuestSearch] = useState('');\n  const [guestResults, setGuestResults] = useState([]);\n  const occupiedBeds = useMemo(() => {\n    if (!resv) return 0;\n    const gc = Number(resv.guests_count || 0);\n    return Math.max(0, Math.min(gc, capacity || 0));\n  }, [resv, capacity]);\n  const loadBeds = useCallback(async () => {\n    try {\n      setLoadingBeds(true);\n      const {\n        data,\n        error\n      } = await supabase.rpc('get_room_beds_status', {\n        p_room_id: room.id,\n        p_date: date\n      });\n      if (error) throw error;\n      setBeds(data || []);\n    } catch (e) {\n      console.warn('get_room_beds_status failed, fallback to capacity squares', (e === null || e === void 0 ? void 0 : e.message) || e);\n      setBeds([]);\n    } finally {\n      setLoadingBeds(false);\n    }\n  }, [room.id, date]);\n  useEffect(() => {\n    loadBeds();\n  }, [loadBeds]);\n  const loadReservationGuests = useCallback(async () => {\n    if (!resv || !resv.id) {\n      setResGuests([]);\n      return;\n    }\n    try {\n      setLoadingGuests(true);\n      const {\n        data,\n        error\n      } = await supabase.rpc('list_reservation_guests', {\n        p_reservation_id: resv.id\n      });\n      if (error) throw error;\n      setResGuests(data || []);\n    } catch (e) {\n      console.warn('list_reservation_guests failed', (e === null || e === void 0 ? void 0 : e.message) || e);\n      setResGuests([]);\n    } finally {\n      setLoadingGuests(false);\n    }\n  }, [resv]);\n  useEffect(() => {\n    loadReservationGuests();\n  }, [loadReservationGuests]);\n  useEffect(() => {\n    const term = (guestSearch || '').trim();\n    if (!term) {\n      setGuestResults([]);\n      return;\n    }\n    const t = setTimeout(async () => {\n      try {\n        const {\n          data,\n          error\n        } = await supabase.from('guests').select('id, full_name, phone, email').or(`full_name.ilike.%${term}%,phone.ilike.%${term}%,email.ilike.%${term}%`).limit(10);\n        if (error) throw error;\n        setGuestResults(data || []);\n      } catch (e) {\n        console.warn('guest search failed', (e === null || e === void 0 ? void 0 : e.message) || e);\n        setGuestResults([]);\n      }\n    }, 350);\n    return () => clearTimeout(t);\n  }, [guestSearch]);\n  const assignMainGuestToBed = async bed => {\n    try {\n      if (!resv) return;\n      const {\n        error\n      } = await supabase.rpc('assign_bed_for_reservation', {\n        p_reservation_id: resv.id,\n        p_room_bed_id: bed.bed_id,\n        p_guest_id: selectedGuestId || resv.guest_id || null,\n        p_start: resv.check_in_date,\n        p_end: resv.check_out_date\n      });\n      if (error) throw error;\n      await loadBeds();\n      await loadReservationGuests();\n    } catch (e) {\n      window.alert('تعذّر إسناد السرير: ' + (e.message || e));\n    }\n  };\n  const unassignBed = async assignmentId => {\n    try {\n      const {\n        error\n      } = await supabase.rpc('unassign_bed', {\n        p_assignment_id: assignmentId\n      });\n      if (error) throw error;\n      await loadBeds();\n      await loadReservationGuests();\n    } catch (e) {\n      window.alert('تعذّر إلغاء إسناد السرير: ' + (e.message || e));\n    }\n  };\n  const addGuestToReservation = async guestId => {\n    try {\n      if (!resv || !resv.id || !guestId) return;\n      const {\n        error\n      } = await supabase.rpc('add_reservation_guest', {\n        p_reservation_id: resv.id,\n        p_guest_id: guestId,\n        p_role: 'additional'\n      });\n      if (error) throw error;\n      setSelectedGuestId(guestId);\n      setGuestSearch('');\n      setGuestResults([]);\n      await loadReservationGuests();\n    } catch (e) {\n      window.alert('تعذّر إضافة الضيف للحجز: ' + (e.message || e));\n    }\n  };\n  const handleDragOver = e => {\n    e.preventDefault();\n  };\n  const handleDrop = e => {\n    e.preventDefault();\n    try {\n      const payload = JSON.parse(e.dataTransfer.getData('application/json'));\n      if (!payload || !payload.id) return;\n      if (String(payload.room_id) === String(room.id)) return; // نفس الغرفة لا حاجة للنقل\n      onDropReservation && onDropReservation(payload, room);\n    } catch (_) {}\n  };\n  const Beds = () => {\n    if (beds.length > 0) {\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex flex-wrap gap-2\",\n        \"aria-label\": `الأسِرّة`,\n        children: beds.map(b => {\n          const filled = !!b.assignment_id;\n          return /*#__PURE__*/_jsxDEV(\"div\", {\n            className: `px-2 py-1 rounded border text-xs flex items-center gap-2 ${filled ? 'bg-blue-50 border-blue-300 text-blue-700' : 'bg-gray-50 border-gray-300 text-gray-700'}`,\n            title: filled ? `مشغول: ${b.guest_name || '—'}` : 'فارغ',\n            children: [/*#__PURE__*/_jsxDEV(\"button\", {\n              className: \"underline\",\n              onClick: () => {\n                if (!filled && resv) assignMainGuestToBed(b);\n              },\n              children: b.bed_code\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 159,\n              columnNumber: 17\n            }, this), filled && /*#__PURE__*/_jsxDEV(_Fragment, {\n              children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                children: [\"\\u2013 \", b.guest_name || 'مجهول']\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 164,\n                columnNumber: 21\n              }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n                className: \"ml-2 text-red-600 hover:text-red-700\",\n                title: \"\\u0625\\u0644\\u063A\\u0627\\u0621\",\n                onClick: () => unassignBed(b.assignment_id),\n                children: \"\\u0625\\u0644\\u063A\\u0627\\u0621 \\u2716\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 165,\n                columnNumber: 21\n              }, this)]\n            }, void 0, true)]\n          }, b.bed_id, true, {\n            fileName: _jsxFileName,\n            lineNumber: 154,\n            columnNumber: 15\n          }, this);\n        })\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 150,\n        columnNumber: 9\n      }, this);\n    }\n    const items = [];\n    for (let i = 0; i < (capacity || 0); i++) {\n      const filled = i < occupiedBeds;\n      items.push(/*#__PURE__*/_jsxDEV(\"div\", {\n        className: `w-5 h-3 rounded-sm border ${filled ? 'bg-blue-500 border-blue-600' : 'bg-gray-100 border-gray-300'}`,\n        title: filled ? 'مشغول' : 'فارغ'\n      }, i, false, {\n        fileName: _jsxFileName,\n        lineNumber: 178,\n        columnNumber: 9\n      }, this));\n    }\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"flex flex-wrap gap-1\",\n      \"aria-label\": `الأسِرّة: ${occupiedBeds}/${capacity}`,\n      children: items\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 182,\n      columnNumber: 7\n    }, this);\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    onDragOver: handleDragOver,\n    onDrop: handleDrop,\n    className: \"bg-white rounded-lg shadow border border-gray-200 overflow-hidden\",\n    dir: \"rtl\",\n    children: [/*#__PURE__*/_jsxDEV(StatusStrip, {\n      status: room.status\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 190,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"p-3\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center justify-between mb-2\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"font-bold text-gray-800\",\n          title: \"\\u0627\\u0644\\u063A\\u0631\\u0641\\u0629\",\n          children: room.room_code || room.room_label\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 193,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"text-xs text-gray-500\",\n          title: \"\\u0627\\u0644\\u0646\\u0648\\u0639\",\n          children: room.room_type_name_ar || room.room_type_name\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 194,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 192,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center justify-between mb-2 text-xs text-gray-600\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          children: [room.floor_name, \" \\u2013 \", room.building_name]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 197,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(CleanBadge, {\n          value: room.cleanliness\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 198,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 196,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"mb-3\",\n        children: /*#__PURE__*/_jsxDEV(Beds, {}, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 201,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 200,\n        columnNumber: 9\n      }, this), resv ? /*#__PURE__*/_jsxDEV(\"div\", {\n        draggable: true,\n        onDragStart: e => {\n          e.dataTransfer.setData('application/json', JSON.stringify({\n            id: resv.id,\n            room_id: resv.room_id,\n            check_in_date: resv.check_in_date,\n            check_out_date: resv.check_out_date\n          }));\n        },\n        className: \"px-2 py-1 rounded text-xs bg-blue-50 border border-blue-200 text-blue-700 cursor-grab\",\n        title: `النزيل: ${resv.guest_name || '—'}`,\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex items-center justify-between gap-2\",\n          children: [/*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"truncate\",\n            children: resv.guest_name || 'نزيل'\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 218,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"text-[10px] text-gray-500\",\n            children: [occupiedBeds, \"/\", capacity]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 219,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 217,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"text-[10px] text-gray-500\",\n          children: [\"\\u0645\\u0646 \", resv.check_in_date, \" \\u0625\\u0644\\u0649 \", resv.check_out_date]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 221,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"mt-2 p-2 bg-gray-50 border border-gray-200 rounded\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"text-xs font-semibold mb-1\",\n            children: \"\\u0636\\u064A\\u0648\\u0641 \\u0627\\u0644\\u062D\\u062C\\u0632\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 224,\n            columnNumber: 15\n          }, this), loadingGuests ? /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"text-xs text-gray-500\",\n            children: \"\\u062C\\u0627\\u0631\\u064A \\u0627\\u0644\\u062A\\u062D\\u0645\\u064A\\u0644...\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 226,\n            columnNumber: 17\n          }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"flex flex-wrap gap-2 mb-2\",\n            children: resGuests.length === 0 ? /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"text-xs text-gray-500\",\n              children: \"\\u0644\\u0627 \\u064A\\u0648\\u062C\\u062F \\u0636\\u064A\\u0648\\u0641 \\u0625\\u0636\\u0627\\u0641\\u064A\\u0648\\u0646.\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 230,\n              columnNumber: 21\n            }, this) : resGuests.map(g => /*#__PURE__*/_jsxDEV(\"label\", {\n              className: `px-2 py-1 rounded border text-xs cursor-pointer ${selectedGuestId === g.guest_id ? 'bg-amber-50 border-amber-300 text-amber-800' : 'bg-white border-gray-300 text-gray-700'}`,\n              children: [/*#__PURE__*/_jsxDEV(\"input\", {\n                type: \"radio\",\n                name: `sel-${resv.id}`,\n                className: \"mr-1\",\n                checked: selectedGuestId === g.guest_id,\n                onChange: () => setSelectedGuestId(g.guest_id)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 233,\n                columnNumber: 23\n              }, this), g.full_name]\n            }, g.reservation_guest_id, true, {\n              fileName: _jsxFileName,\n              lineNumber: 232,\n              columnNumber: 21\n            }, this))\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 228,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"flex items-center gap-2\",\n            children: [/*#__PURE__*/_jsxDEV(\"input\", {\n              value: guestSearch,\n              onChange: e => setGuestSearch(e.target.value),\n              className: \"border rounded px-2 py-1 text-xs flex-1\",\n              placeholder: \"\\u0628\\u062D\\u062B: \\u0627\\u0644\\u0627\\u0633\\u0645/\\u0627\\u0644\\u0647\\u0627\\u062A\\u0641/\\u0627\\u0644\\u0628\\u0631\\u064A\\u062F\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 240,\n              columnNumber: 17\n            }, this), guestResults.length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"absolute mt-10 bg-white border rounded shadow p-2 text-xs max-h-40 overflow-auto z-10\",\n              children: guestResults.map(gr => /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"px-2 py-1 hover:bg-gray-100 cursor-pointer\",\n                onClick: () => addGuestToReservation(gr.id),\n                children: [gr.full_name, \" \", /*#__PURE__*/_jsxDEV(\"span\", {\n                  className: \"text-gray-500\",\n                  children: [\"(\", gr.phone || gr.email || gr.id.slice(0, 8), \")\"]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 245,\n                  columnNumber: 40\n                }, this)]\n              }, gr.id, true, {\n                fileName: _jsxFileName,\n                lineNumber: 244,\n                columnNumber: 23\n              }, this))\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 242,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 239,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"mt-2 text-[11px] text-gray-500\",\n            children: \"\\u0627\\u062E\\u062A\\u0631 \\u0636\\u064A\\u0641\\u064B\\u0627\\u060C \\u062B\\u0645 \\u0627\\u0636\\u063A\\u0637 \\u0639\\u0644\\u0649 \\u0633\\u0631\\u064A\\u0631 \\u0641\\u0627\\u0631\\u063A \\u0644\\u0625\\u0633\\u0646\\u0627\\u062F\\u0647.\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 251,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 223,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 204,\n        columnNumber: 11\n      }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"text-xs text-gray-400\",\n        children: \"\\u0644\\u0627 \\u064A\\u0648\\u062C\\u062F \\u062D\\u062C\\u0632 \\u0641\\u064A \\u0647\\u0630\\u0627 \\u0627\\u0644\\u062A\\u0627\\u0631\\u064A\\u062E\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 255,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 191,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 189,\n    columnNumber: 5\n  }, this);\n}\n_s(RoomTile, \"0r1yiNjAc4CH4ZJgUnKh0Dn3ZRo=\");\n_c3 = RoomTile;\nexport default function Tashkeen() {\n  _s2();\n  const [date, setDate] = useState(() => new Date().toISOString().slice(0, 10));\n  const [rooms, setRooms] = useState([]);\n  const [resvs, setResvs] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const loadRooms = useCallback(async () => {\n    // محاولة أولى: عرض rooms_overview إن وُجد\n    try {\n      const {\n        data,\n        error\n      } = await supabase.from('rooms_overview').select('id, room_code, room_label, status, cleanliness, max_guests, room_type_name_ar, room_type_name, building_id, building_name, floor_id, floor_name').order('room_code');\n      if (error) throw error;\n      if (data && data.length > 0) {\n        setRooms(data);\n        return;\n      }\n    } catch (e) {\n      console.warn('rooms_overview unavailable, falling back to base tables:', (e === null || e === void 0 ? void 0 : e.message) || e);\n    }\n\n    // بديل: الجداول الأساسية + عمليات إغناء عميلًا\n    try {\n      const [roomsRes, typesRes, buildingsRes, floorsRes] = await Promise.all([supabase.from('rooms').select('id, room_code, status, cleanliness, room_type_id, building_id, floor_id').order('room_code'), supabase.from('room_types_active').select('id, name, name_ar, max_guests').order('display_order'), supabase.from('buildings').select('id, name').order('name'), supabase.from('floors').select('id, name, floor_number, number, building_id').order('id')]);\n\n      // لو فشل room_types_active جرّب room_types العادية\n      let types = typesRes.data || [];\n      if (typesRes.error || types.length === 0) {\n        try {\n          const alt = await supabase.from('room_types').select('id, name, name_ar, max_guests').order('id');\n          if (!alt.error) types = alt.data || [];\n        } catch (_) {}\n      }\n      const typeMap = new Map();\n      types.forEach(t => typeMap.set(String(t.id), t));\n      const bMap = new Map();\n      (buildingsRes.data || []).forEach(b => bMap.set(String(b.id), b));\n      const fMap = new Map();\n      (floorsRes.data || []).forEach(f => fMap.set(String(f.id), f));\n      const enriched = (roomsRes.data || []).map(r => {\n        const t = typeMap.get(String(r.room_type_id));\n        const b = bMap.get(String(r.building_id));\n        const f = fMap.get(String(r.floor_id));\n        const room_label = r.room_code || (r.id ? `غرفة #${String(r.id).slice(0, 8)}` : 'غرفة');\n        const building_name = (b === null || b === void 0 ? void 0 : b.name) || 'مبنى';\n        const floor_name = (f === null || f === void 0 ? void 0 : f.name) || (f !== null && f !== void 0 && f.floor_number ? `الطابق ${f.floor_number}` : f !== null && f !== void 0 && f.number ? `الطابق ${f.number}` : 'طابق');\n        return {\n          id: r.id,\n          room_code: r.room_code,\n          room_label,\n          status: r.status,\n          cleanliness: r.cleanliness,\n          max_guests: (t === null || t === void 0 ? void 0 : t.max_guests) || 0,\n          room_type_name_ar: t === null || t === void 0 ? void 0 : t.name_ar,\n          room_type_name: t === null || t === void 0 ? void 0 : t.name,\n          building_id: r.building_id,\n          building_name,\n          floor_id: r.floor_id,\n          floor_name\n        };\n      });\n      setRooms(enriched);\n    } catch (e2) {\n      console.error('Fallback loadRooms failed', e2);\n      setRooms([]);\n    }\n  }, []);\n  const loadResvsForDate = useCallback(async d => {\n    try {\n      // الحجز الذي يغطي اليوم d: check_in <= d AND check_out >= d\n      const {\n        data,\n        error\n      } = await supabase.from('reservations').select('id, room_id, guest_id, guests_count, status, check_in_date, check_out_date, guests(full_name)').in('status', ['pending', 'confirmed', 'checked_in']).lte('check_in_date', d).gte('check_out_date', d);\n      if (error) throw error;\n      const mapped = (data || []).map(r => ({\n        id: r.id,\n        room_id: r.room_id,\n        guests_count: r.guests_count,\n        status: r.status,\n        check_in_date: r.check_in_date,\n        check_out_date: r.check_out_date,\n        guest_name: r.guests && r.guests.full_name ? r.guests.full_name : undefined\n      }));\n      setResvs(mapped);\n    } catch (e) {\n      console.error('loadResvsForDate failed', e);\n      setResvs([]);\n    }\n  }, []);\n  const reloadAll = useCallback(async () => {\n    setLoading(true);\n    await Promise.all([loadRooms(), loadResvsForDate(date)]);\n    setLoading(false);\n  }, [date, loadRooms, loadResvsForDate]);\n  useEffect(() => {\n    reloadAll();\n  }, [reloadAll]);\n  useEffect(() => {\n    const ch = supabase.channel('tashkeen-live').on('postgres_changes', {\n      event: '*',\n      schema: 'public',\n      table: 'reservations'\n    }, () => {\n      loadResvsForDate(date);\n    }).on('postgres_changes', {\n      event: '*',\n      schema: 'public',\n      table: 'rooms'\n    }, () => {\n      loadRooms();\n    }).subscribe();\n    return () => {\n      try {\n        supabase.removeChannel(ch);\n      } catch (_) {}\n    };\n  }, [date, loadRooms, loadResvsForDate]);\n  const resvByRoom = useMemo(() => {\n    const m = new Map();\n    resvs.forEach(r => {\n      m.set(String(r.room_id), r);\n    });\n    return m;\n  }, [resvs]);\n  const groups = useMemo(() => {\n    // تجميع حسب المبنى ثم الطابق\n    const byBuilding = new Map();\n    rooms.forEach(r => {\n      const bKey = String(r.building_id || r.building_name || '—');\n      const fKey = String(r.floor_id || r.floor_name || '—');\n      if (!byBuilding.has(bKey)) byBuilding.set(bKey, {\n        label: r.building_name || 'مبنى',\n        floors: new Map()\n      });\n      const bObj = byBuilding.get(bKey);\n      if (!bObj.floors.has(fKey)) bObj.floors.set(fKey, {\n        label: r.floor_name || 'طابق',\n        rooms: []\n      });\n      bObj.floors.get(fKey).rooms.push(r);\n    });\n    // تحويل إلى مصفوفة قابلة للعرض\n    return Array.from(byBuilding.values()).map(b => ({\n      label: b.label,\n      floors: Array.from(b.floors.values()).map(f => ({\n        label: f.label,\n        rooms: f.rooms\n      }))\n    }));\n  }, [rooms]);\n  const onDropReservation = async (payload, targetRoom) => {\n    try {\n      const ok = window.confirm(`نقل الحجز إلى ${targetRoom.room_code || targetRoom.room_label} لنفس التواريخ؟`);\n      if (!ok) return;\n      const {\n        data,\n        error\n      } = await supabase.rpc('move_reservation', {\n        p_reservation_id: payload.id,\n        p_new_room_id: targetRoom.id,\n        p_new_check_in: payload.check_in_date,\n        p_new_check_out: payload.check_out_date\n      });\n      if (error) throw error;\n      // تحديث\n      await loadResvsForDate(date);\n      window.alert('تم نقل الحجز بنجاح.');\n    } catch (e) {\n      console.error('move failed', e);\n      window.alert('تعذّر نقل الحجز: ' + (e.message || e));\n    }\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"p-8\",\n    dir: \"rtl\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"flex items-center justify-between mb-6\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n          className: \"text-2xl font-bold\",\n          children: \"\\u0627\\u0644\\u062A\\u0633\\u0643\\u064A\\u0646 (\\u0639\\u0631\\u0636 \\u0625\\u0634\\u063A\\u0627\\u0644 \\u0627\\u0644\\u0623\\u0633\\u0650\\u0631\\u0651\\u0629)\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 428,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n          className: \"text-sm text-gray-500\",\n          children: \"\\u0639\\u0631\\u0636 \\u0628\\u0635\\u0631\\u064A \\u0644\\u0639\\u062F\\u062F \\u0627\\u0644\\u0623\\u0633\\u0650\\u0631\\u0651\\u0629 \\u062D\\u0633\\u0628 \\u0633\\u0639\\u0629 \\u0627\\u0644\\u063A\\u0631\\u0641\\u0629 \\u0648\\u0645\\u0644\\u0624\\u0647\\u0627 \\u0628\\u0627\\u0644\\u062D\\u062C\\u0648\\u0632\\u0627\\u062A \\u0627\\u0644\\u062C\\u0627\\u0631\\u064A\\u0629 \\u0641\\u064A \\u0627\\u0644\\u062A\\u0627\\u0631\\u064A\\u062E \\u0627\\u0644\\u0645\\u062D\\u062F\\u062F.\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 429,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 427,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center gap-2\",\n        children: [/*#__PURE__*/_jsxDEV(\"input\", {\n          type: \"date\",\n          className: \"border rounded px-3 py-2\",\n          value: date,\n          onChange: e => setDate(e.target.value),\n          title: \"\\u0627\\u062E\\u062A\\u0631 \\u0627\\u0644\\u062A\\u0627\\u0631\\u064A\\u062E\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 432,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"border rounded px-3 py-2 bg-white hover:bg-gray-50\",\n          onClick: () => setDate(new Date().toISOString().slice(0, 10)),\n          children: \"\\u0627\\u0644\\u064A\\u0648\\u0645\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 439,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 431,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 426,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800\",\n      children: [\"- \\u0627\\u0633\\u062D\\u0628 \\u0628\\u0637\\u0627\\u0642\\u0629 \\u0627\\u0644\\u0646\\u0632\\u064A\\u0644 \\u0645\\u0646 \\u063A\\u0631\\u0641\\u0629 \\u0625\\u0644\\u0649 \\u0623\\u062E\\u0631\\u0649 \\u0644\\u0646\\u0642\\u0644 \\u0627\\u0644\\u062D\\u062C\\u0632 \\u0644\\u0646\\u0641\\u0633 \\u0627\\u0644\\u0645\\u062F\\u0629. \", /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 445,\n        columnNumber: 69\n      }, this), \"- \\u0643\\u0644 \\u0645\\u0633\\u062A\\u0637\\u064A\\u0644 \\u0635\\u063A\\u064A\\u0631 \\u064A\\u0645\\u062B\\u0644 \\u0633\\u0631\\u064A\\u0631\\u064B\\u0627\\u061B \\u0627\\u0644\\u0645\\u0645\\u062A\\u0644\\u0626 \\u064A\\u0639\\u0646\\u064A \\u0645\\u0634\\u063A\\u0648\\u0644 \\u062D\\u0633\\u0628 \\u0639\\u062F\\u062F \\u0627\\u0644\\u0636\\u064A\\u0648\\u0641 \\u0641\\u064A \\u0627\\u0644\\u062D\\u062C\\u0632. \", /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 446,\n        columnNumber: 83\n      }, this), \"- \\u064A\\u0645\\u0643\\u0646\\u0643 \\u062A\\u063A\\u064A\\u064A\\u0631 \\u0627\\u0644\\u062A\\u0627\\u0631\\u064A\\u062E \\u0645\\u0646 \\u0627\\u0644\\u0623\\u0639\\u0644\\u0649 \\u0644\\u0645\\u0634\\u0627\\u0647\\u062F\\u0629 \\u0625\\u0634\\u063A\\u0627\\u0644 \\u064A\\u0648\\u0645 \\u0645\\u0639\\u064A\\u0646.\"]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 444,\n      columnNumber: 7\n    }, this), loading ? /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"text-gray-500\",\n      children: \"\\u062C\\u0627\\u0631\\u064A \\u0627\\u0644\\u062A\\u062D\\u0645\\u064A\\u0644...\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 451,\n      columnNumber: 9\n    }, this) : groups.length === 0 ? /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"text-gray-500\",\n      children: \"\\u0644\\u0627 \\u062A\\u0648\\u062C\\u062F \\u063A\\u0631\\u0641.\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 453,\n      columnNumber: 9\n    }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"space-y-8\",\n      children: groups.map((b, bi) => /*#__PURE__*/_jsxDEV(\"div\", {\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"text-lg font-bold text-gray-800 mb-3\",\n          children: b.label\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 458,\n          columnNumber: 15\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"space-y-6\",\n          children: b.floors.map((f, fi) => /*#__PURE__*/_jsxDEV(\"div\", {\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"text-sm font-semibold text-gray-700 mb-2\",\n              children: f.label\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 462,\n              columnNumber: 21\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\",\n              children: f.rooms.map(room => /*#__PURE__*/_jsxDEV(RoomTile, {\n                room: room,\n                resv: resvByRoom.get(String(room.id)),\n                date: date,\n                onDropReservation: onDropReservation\n              }, room.id, false, {\n                fileName: _jsxFileName,\n                lineNumber: 465,\n                columnNumber: 25\n              }, this))\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 463,\n              columnNumber: 21\n            }, this)]\n          }, fi, true, {\n            fileName: _jsxFileName,\n            lineNumber: 461,\n            columnNumber: 19\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 459,\n          columnNumber: 15\n        }, this)]\n      }, bi, true, {\n        fileName: _jsxFileName,\n        lineNumber: 457,\n        columnNumber: 13\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 455,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 425,\n    columnNumber: 5\n  }, this);\n}\n_s2(Tashkeen, \"VTCxuVzt4wTcJ5W1Fmq8kflyx2s=\");\n_c4 = Tashkeen;\nvar _c, _c2, _c3, _c4;\n$RefreshReg$(_c, \"StatusStrip\");\n$RefreshReg$(_c2, \"CleanBadge\");\n$RefreshReg$(_c3, \"RoomTile\");\n$RefreshReg$(_c4, \"Tashkeen\");","map":{"version":3,"names":["React","useEffect","useMemo","useState","useCallback","supabase","jsxDEV","_jsxDEV","Fragment","_Fragment","StatusStrip","status","cls","className","fileName","_jsxFileName","lineNumber","columnNumber","_c","CleanBadge","value","map","clean","text","in_cleaning","needs_cleaning","v","children","_c2","RoomTile","room","resv","date","onDropReservation","_s","capacity","Number","max_guests","beds","setBeds","loadingBeds","setLoadingBeds","resGuests","setResGuests","loadingGuests","setLoadingGuests","selectedGuestId","setSelectedGuestId","guestSearch","setGuestSearch","guestResults","setGuestResults","occupiedBeds","gc","guests_count","Math","max","min","loadBeds","data","error","rpc","p_room_id","id","p_date","e","console","warn","message","loadReservationGuests","p_reservation_id","term","trim","t","setTimeout","from","select","or","limit","clearTimeout","assignMainGuestToBed","bed","p_room_bed_id","bed_id","p_guest_id","guest_id","p_start","check_in_date","p_end","check_out_date","window","alert","unassignBed","assignmentId","p_assignment_id","addGuestToReservation","guestId","p_role","handleDragOver","preventDefault","handleDrop","payload","JSON","parse","dataTransfer","getData","String","room_id","_","Beds","length","b","filled","assignment_id","title","guest_name","onClick","bed_code","items","i","push","onDragOver","onDrop","dir","room_code","room_label","room_type_name_ar","room_type_name","floor_name","building_name","cleanliness","draggable","onDragStart","setData","stringify","g","type","name","checked","onChange","full_name","reservation_guest_id","target","placeholder","gr","phone","email","slice","_c3","Tashkeen","_s2","setDate","Date","toISOString","rooms","setRooms","resvs","setResvs","loading","setLoading","loadRooms","order","roomsRes","typesRes","buildingsRes","floorsRes","Promise","all","types","alt","typeMap","Map","forEach","set","bMap","fMap","f","enriched","r","get","room_type_id","building_id","floor_id","floor_number","number","name_ar","e2","loadResvsForDate","d","in","lte","gte","mapped","guests","undefined","reloadAll","ch","channel","on","event","schema","table","subscribe","removeChannel","resvByRoom","m","groups","byBuilding","bKey","fKey","has","label","floors","bObj","Array","values","targetRoom","ok","confirm","p_new_room_id","p_new_check_in","p_new_check_out","bi","fi","_c4","$RefreshReg$"],"sources":["F:/kelany/src/pages/Tashkeen.jsx"],"sourcesContent":["import React, { useEffect, useMemo, useState, useCallback } from 'react';\r\nimport { supabase } from '../supabaseClient';\r\n\r\nfunction StatusStrip({ status }) {\r\n  const cls = status === 'available' ? 'bg-status-available'\r\n    : status === 'reserved' ? 'bg-status-reserved'\r\n    : status === 'occupied' ? 'bg-status-occupied'\r\n    : status === 'maintenance' ? 'bg-status-maintenance' : 'bg-gray-300';\r\n  return <div className={`h-1 ${cls}`} />;\r\n}\r\n\r\nfunction CleanBadge({ value }) {\r\n  const map = {\r\n    clean: { text: 'نظيفة', cls: 'bg-green-100 text-green-700' },\r\n    in_cleaning: { text: 'جاري تنظيف', cls: 'bg-amber-100 text-amber-700' },\r\n    needs_cleaning: { text: 'تحتاج نظافة', cls: 'bg-red-100 text-red-700' },\r\n  };\r\n  const v = map[value] || map.clean;\r\n  return <span className={`text-xs px-2 py-1 rounded ${v.cls}`}>{v.text}</span>;\r\n}\r\n\r\nfunction RoomTile({ room, resv, date, onDropReservation }) {\r\n  const capacity = Number(room.max_guests || room.capacity || 0);\r\n  const [beds, setBeds] = useState([]);\r\n  const [loadingBeds, setLoadingBeds] = useState(false);\r\n  const [resGuests, setResGuests] = useState([]);\r\n  const [loadingGuests, setLoadingGuests] = useState(false);\r\n  const [selectedGuestId, setSelectedGuestId] = useState(null);\r\n  const [guestSearch, setGuestSearch] = useState('');\r\n  const [guestResults, setGuestResults] = useState([]);\r\n\r\n  const occupiedBeds = useMemo(() => {\r\n    if (!resv) return 0;\r\n    const gc = Number(resv.guests_count || 0);\r\n    return Math.max(0, Math.min(gc, capacity || 0));\r\n  }, [resv, capacity]);\r\n\r\n  const loadBeds = useCallback(async () => {\r\n    try {\r\n      setLoadingBeds(true);\r\n      const { data, error } = await supabase.rpc('get_room_beds_status', { p_room_id: room.id, p_date: date });\r\n      if (error) throw error;\r\n      setBeds(data || []);\r\n    } catch (e) {\r\n      console.warn('get_room_beds_status failed, fallback to capacity squares', e?.message || e);\r\n      setBeds([]);\r\n    } finally {\r\n      setLoadingBeds(false);\r\n    }\r\n  }, [room.id, date]);\r\n\r\n  useEffect(() => { loadBeds(); }, [loadBeds]);\r\n\r\n  const loadReservationGuests = useCallback(async () => {\r\n    if (!resv || !resv.id) { setResGuests([]); return; }\r\n    try {\r\n      setLoadingGuests(true);\r\n      const { data, error } = await supabase.rpc('list_reservation_guests', { p_reservation_id: resv.id });\r\n      if (error) throw error;\r\n      setResGuests(data || []);\r\n    } catch (e) {\r\n      console.warn('list_reservation_guests failed', e?.message || e);\r\n      setResGuests([]);\r\n    } finally {\r\n      setLoadingGuests(false);\r\n    }\r\n  }, [resv]);\r\n\r\n  useEffect(() => { loadReservationGuests(); }, [loadReservationGuests]);\r\n\r\n  useEffect(() => {\r\n    const term = (guestSearch || '').trim();\r\n    if (!term) { setGuestResults([]); return; }\r\n    const t = setTimeout(async () => {\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('guests')\r\n          .select('id, full_name, phone, email')\r\n          .or(`full_name.ilike.%${term}%,phone.ilike.%${term}%,email.ilike.%${term}%`)\r\n          .limit(10);\r\n        if (error) throw error;\r\n        setGuestResults(data || []);\r\n      } catch (e) {\r\n        console.warn('guest search failed', e?.message || e);\r\n        setGuestResults([]);\r\n      }\r\n    }, 350);\r\n    return () => clearTimeout(t);\r\n  }, [guestSearch]);\r\n\r\n  const assignMainGuestToBed = async (bed) => {\r\n    try {\r\n      if (!resv) return;\r\n      const { error } = await supabase.rpc('assign_bed_for_reservation', {\r\n        p_reservation_id: resv.id,\r\n        p_room_bed_id: bed.bed_id,\r\n        p_guest_id: selectedGuestId || resv.guest_id || null,\r\n        p_start: resv.check_in_date,\r\n        p_end: resv.check_out_date,\r\n      });\r\n      if (error) throw error;\r\n      await loadBeds();\r\n      await loadReservationGuests();\r\n    } catch (e) {\r\n      window.alert('تعذّر إسناد السرير: ' + (e.message || e));\r\n    }\r\n  };\r\n\r\n  const unassignBed = async (assignmentId) => {\r\n    try {\r\n      const { error } = await supabase.rpc('unassign_bed', { p_assignment_id: assignmentId });\r\n      if (error) throw error;\r\n      await loadBeds();\r\n      await loadReservationGuests();\r\n    } catch (e) {\r\n      window.alert('تعذّر إلغاء إسناد السرير: ' + (e.message || e));\r\n    }\r\n  };\r\n\r\n  const addGuestToReservation = async (guestId) => {\r\n    try {\r\n      if (!resv || !resv.id || !guestId) return;\r\n      const { error } = await supabase.rpc('add_reservation_guest', { p_reservation_id: resv.id, p_guest_id: guestId, p_role: 'additional' });\r\n      if (error) throw error;\r\n      setSelectedGuestId(guestId);\r\n      setGuestSearch('');\r\n      setGuestResults([]);\r\n      await loadReservationGuests();\r\n    } catch (e) {\r\n      window.alert('تعذّر إضافة الضيف للحجز: ' + (e.message || e));\r\n    }\r\n  };\r\n\r\n  const handleDragOver = (e) => {\r\n    e.preventDefault();\r\n  };\r\n  const handleDrop = (e) => {\r\n    e.preventDefault();\r\n    try {\r\n      const payload = JSON.parse(e.dataTransfer.getData('application/json'));\r\n      if (!payload || !payload.id) return;\r\n      if (String(payload.room_id) === String(room.id)) return; // نفس الغرفة لا حاجة للنقل\r\n      onDropReservation && onDropReservation(payload, room);\r\n    } catch (_) {}\r\n  };\r\n\r\n  const Beds = () => {\r\n    if (beds.length > 0) {\r\n      return (\r\n        <div className=\"flex flex-wrap gap-2\" aria-label={`الأسِرّة`}>\r\n          {beds.map(b => {\r\n            const filled = !!b.assignment_id;\r\n            return (\r\n              <div\r\n                key={b.bed_id}\r\n                className={`px-2 py-1 rounded border text-xs flex items-center gap-2 ${filled ? 'bg-blue-50 border-blue-300 text-blue-700' : 'bg-gray-50 border-gray-300 text-gray-700'}`}\r\n                title={filled ? `مشغول: ${b.guest_name || '—'}` : 'فارغ'}\r\n              >\r\n                <button className=\"underline\" onClick={() => { if (!filled && resv) assignMainGuestToBed(b); }}>\r\n                  {b.bed_code}\r\n                </button>\r\n                {filled && (\r\n                  <>\r\n                    <span>– {b.guest_name || 'مجهول'}</span>\r\n                    <button className=\"ml-2 text-red-600 hover:text-red-700\" title=\"إلغاء\" onClick={() => unassignBed(b.assignment_id)}>إلغاء ✖</button>\r\n                  </>\r\n                )}\r\n              </div>\r\n            );\r\n          })}\r\n        </div>\r\n      );\r\n    }\r\n    const items = [];\r\n    for (let i = 0; i < (capacity || 0); i++) {\r\n      const filled = i < occupiedBeds;\r\n      items.push(\r\n        <div key={i} className={`w-5 h-3 rounded-sm border ${filled ? 'bg-blue-500 border-blue-600' : 'bg-gray-100 border-gray-300'}`} title={filled ? 'مشغول' : 'فارغ'} />\r\n      );\r\n    }\r\n    return (\r\n      <div className=\"flex flex-wrap gap-1\" aria-label={`الأسِرّة: ${occupiedBeds}/${capacity}`}>\r\n        {items}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div onDragOver={handleDragOver} onDrop={handleDrop} className=\"bg-white rounded-lg shadow border border-gray-200 overflow-hidden\" dir=\"rtl\">\r\n      <StatusStrip status={room.status} />\r\n      <div className=\"p-3\">\r\n        <div className=\"flex items-center justify-between mb-2\">\r\n          <div className=\"font-bold text-gray-800\" title=\"الغرفة\">{room.room_code || room.room_label}</div>\r\n          <div className=\"text-xs text-gray-500\" title=\"النوع\">{room.room_type_name_ar || room.room_type_name}</div>\r\n        </div>\r\n        <div className=\"flex items-center justify-between mb-2 text-xs text-gray-600\">\r\n          <div>{room.floor_name} – {room.building_name}</div>\r\n          <CleanBadge value={room.cleanliness} />\r\n        </div>\r\n        <div className=\"mb-3\">\r\n          <Beds />\r\n        </div>\r\n        {resv ? (\r\n          <div\r\n            draggable\r\n            onDragStart={(e)=>{\r\n              e.dataTransfer.setData('application/json', JSON.stringify({\r\n                id: resv.id,\r\n                room_id: resv.room_id,\r\n                check_in_date: resv.check_in_date,\r\n                check_out_date: resv.check_out_date\r\n              }));\r\n            }}\r\n            className=\"px-2 py-1 rounded text-xs bg-blue-50 border border-blue-200 text-blue-700 cursor-grab\"\r\n            title={`النزيل: ${resv.guest_name || '—'}`}\r\n          >\r\n            <div className=\"flex items-center justify-between gap-2\">\r\n              <span className=\"truncate\">{resv.guest_name || 'نزيل'}</span>\r\n              <span className=\"text-[10px] text-gray-500\">{occupiedBeds}/{capacity}</span>\r\n            </div>\r\n            <div className=\"text-[10px] text-gray-500\">من {resv.check_in_date} إلى {resv.check_out_date}</div>\r\n            {/* Reservation guests panel */}\r\n            <div className=\"mt-2 p-2 bg-gray-50 border border-gray-200 rounded\">\r\n              <div className=\"text-xs font-semibold mb-1\">ضيوف الحجز</div>\r\n              {loadingGuests ? (\r\n                <div className=\"text-xs text-gray-500\">جاري التحميل...</div>\r\n              ) : (\r\n                <div className=\"flex flex-wrap gap-2 mb-2\">\r\n                  {resGuests.length === 0 ? (\r\n                    <span className=\"text-xs text-gray-500\">لا يوجد ضيوف إضافيون.</span>\r\n                  ) : resGuests.map(g => (\r\n                    <label key={g.reservation_guest_id} className={`px-2 py-1 rounded border text-xs cursor-pointer ${selectedGuestId===g.guest_id ? 'bg-amber-50 border-amber-300 text-amber-800' : 'bg-white border-gray-300 text-gray-700'}`}>\r\n                      <input type=\"radio\" name={`sel-${resv.id}`} className=\"mr-1\" checked={selectedGuestId===g.guest_id} onChange={()=>setSelectedGuestId(g.guest_id)} />\r\n                      {g.full_name}\r\n                    </label>\r\n                  ))}\r\n                </div>\r\n              )}\r\n              <div className=\"flex items-center gap-2\">\r\n                <input value={guestSearch} onChange={(e)=>setGuestSearch(e.target.value)} className=\"border rounded px-2 py-1 text-xs flex-1\" placeholder=\"بحث: الاسم/الهاتف/البريد\" />\r\n                {guestResults.length > 0 && (\r\n                  <div className=\"absolute mt-10 bg-white border rounded shadow p-2 text-xs max-h-40 overflow-auto z-10\">\r\n                    {guestResults.map(gr => (\r\n                      <div key={gr.id} className=\"px-2 py-1 hover:bg-gray-100 cursor-pointer\" onClick={()=>addGuestToReservation(gr.id)}>\r\n                        {gr.full_name} <span className=\"text-gray-500\">({gr.phone || gr.email || gr.id.slice(0,8)})</span>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </div>\r\n              <div className=\"mt-2 text-[11px] text-gray-500\">اختر ضيفًا، ثم اضغط على سرير فارغ لإسناده.</div>\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <div className=\"text-xs text-gray-400\">لا يوجد حجز في هذا التاريخ</div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function Tashkeen() {\r\n  const [date, setDate] = useState(() => new Date().toISOString().slice(0,10));\r\n  const [rooms, setRooms] = useState([]);\r\n  const [resvs, setResvs] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const loadRooms = useCallback(async () => {\r\n    // محاولة أولى: عرض rooms_overview إن وُجد\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('rooms_overview')\r\n        .select('id, room_code, room_label, status, cleanliness, max_guests, room_type_name_ar, room_type_name, building_id, building_name, floor_id, floor_name')\r\n        .order('room_code');\r\n      if (error) throw error;\r\n      if (data && data.length > 0) {\r\n        setRooms(data);\r\n        return;\r\n      }\r\n    } catch (e) {\r\n      console.warn('rooms_overview unavailable, falling back to base tables:', e?.message || e);\r\n    }\r\n\r\n    // بديل: الجداول الأساسية + عمليات إغناء عميلًا\r\n    try {\r\n      const [roomsRes, typesRes, buildingsRes, floorsRes] = await Promise.all([\r\n        supabase.from('rooms').select('id, room_code, status, cleanliness, room_type_id, building_id, floor_id').order('room_code'),\r\n        supabase.from('room_types_active').select('id, name, name_ar, max_guests').order('display_order'),\r\n        supabase.from('buildings').select('id, name').order('name'),\r\n        supabase.from('floors').select('id, name, floor_number, number, building_id').order('id'),\r\n      ]);\r\n\r\n      // لو فشل room_types_active جرّب room_types العادية\r\n      let types = typesRes.data || [];\r\n      if (typesRes.error || types.length === 0) {\r\n        try {\r\n          const alt = await supabase.from('room_types').select('id, name, name_ar, max_guests').order('id');\r\n          if (!alt.error) types = alt.data || [];\r\n        } catch (_) {}\r\n      }\r\n\r\n      const typeMap = new Map();\r\n      types.forEach(t => typeMap.set(String(t.id), t));\r\n      const bMap = new Map();\r\n      (buildingsRes.data || []).forEach(b => bMap.set(String(b.id), b));\r\n      const fMap = new Map();\r\n      (floorsRes.data || []).forEach(f => fMap.set(String(f.id), f));\r\n\r\n      const enriched = (roomsRes.data || []).map(r => {\r\n        const t = typeMap.get(String(r.room_type_id));\r\n        const b = bMap.get(String(r.building_id));\r\n        const f = fMap.get(String(r.floor_id));\r\n        const room_label = r.room_code || (r.id ? `غرفة #${String(r.id).slice(0,8)}` : 'غرفة');\r\n        const building_name = b?.name || 'مبنى';\r\n        const floor_name = f?.name || (f?.floor_number ? `الطابق ${f.floor_number}` : (f?.number ? `الطابق ${f.number}` : 'طابق'));\r\n        return {\r\n          id: r.id,\r\n          room_code: r.room_code,\r\n          room_label,\r\n          status: r.status,\r\n          cleanliness: r.cleanliness,\r\n          max_guests: t?.max_guests || 0,\r\n          room_type_name_ar: t?.name_ar,\r\n          room_type_name: t?.name,\r\n          building_id: r.building_id,\r\n          building_name,\r\n          floor_id: r.floor_id,\r\n          floor_name,\r\n        };\r\n      });\r\n      setRooms(enriched);\r\n    } catch (e2) {\r\n      console.error('Fallback loadRooms failed', e2);\r\n      setRooms([]);\r\n    }\r\n  }, []);\r\n\r\n  const loadResvsForDate = useCallback(async (d) => {\r\n    try {\r\n      // الحجز الذي يغطي اليوم d: check_in <= d AND check_out >= d\r\n      const { data, error } = await supabase\r\n        .from('reservations')\r\n        .select('id, room_id, guest_id, guests_count, status, check_in_date, check_out_date, guests(full_name)')\r\n        .in('status', ['pending','confirmed','checked_in'])\r\n        .lte('check_in_date', d)\r\n        .gte('check_out_date', d);\r\n      if (error) throw error;\r\n      const mapped = (data || []).map(r => ({\r\n        id: r.id,\r\n        room_id: r.room_id,\r\n        guests_count: r.guests_count,\r\n        status: r.status,\r\n        check_in_date: r.check_in_date,\r\n        check_out_date: r.check_out_date,\r\n        guest_name: (r.guests && r.guests.full_name) ? r.guests.full_name : undefined,\r\n      }));\r\n      setResvs(mapped);\r\n    } catch (e) {\r\n      console.error('loadResvsForDate failed', e);\r\n      setResvs([]);\r\n    }\r\n  }, []);\r\n\r\n  const reloadAll = useCallback(async () => {\r\n    setLoading(true);\r\n    await Promise.all([loadRooms(), loadResvsForDate(date)]);\r\n    setLoading(false);\r\n  }, [date, loadRooms, loadResvsForDate]);\r\n\r\n  useEffect(() => { reloadAll(); }, [reloadAll]);\r\n\r\n  useEffect(() => {\r\n    const ch = supabase.channel('tashkeen-live')\r\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'reservations' }, () => { loadResvsForDate(date); })\r\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, () => { loadRooms(); })\r\n      .subscribe();\r\n    return () => { try { supabase.removeChannel(ch); } catch(_) {} };\r\n  }, [date, loadRooms, loadResvsForDate]);\r\n\r\n  const resvByRoom = useMemo(() => {\r\n    const m = new Map();\r\n    resvs.forEach(r => { m.set(String(r.room_id), r); });\r\n    return m;\r\n  }, [resvs]);\r\n\r\n  const groups = useMemo(() => {\r\n    // تجميع حسب المبنى ثم الطابق\r\n    const byBuilding = new Map();\r\n    rooms.forEach(r => {\r\n      const bKey = String(r.building_id || r.building_name || '—');\r\n      const fKey = String(r.floor_id || r.floor_name || '—');\r\n      if (!byBuilding.has(bKey)) byBuilding.set(bKey, { label: r.building_name || 'مبنى', floors: new Map() });\r\n      const bObj = byBuilding.get(bKey);\r\n      if (!bObj.floors.has(fKey)) bObj.floors.set(fKey, { label: r.floor_name || 'طابق', rooms: [] });\r\n      bObj.floors.get(fKey).rooms.push(r);\r\n    });\r\n    // تحويل إلى مصفوفة قابلة للعرض\r\n    return Array.from(byBuilding.values()).map(b => ({\r\n      label: b.label,\r\n      floors: Array.from(b.floors.values()).map(f => ({ label: f.label, rooms: f.rooms }))\r\n    }));\r\n  }, [rooms]);\r\n\r\n  const onDropReservation = async (payload, targetRoom) => {\r\n    try {\r\n      const ok = window.confirm(`نقل الحجز إلى ${targetRoom.room_code || targetRoom.room_label} لنفس التواريخ؟`);\r\n      if (!ok) return;\r\n      const { data, error } = await supabase.rpc('move_reservation', {\r\n        p_reservation_id: payload.id,\r\n        p_new_room_id: targetRoom.id,\r\n        p_new_check_in: payload.check_in_date,\r\n        p_new_check_out: payload.check_out_date,\r\n      });\r\n      if (error) throw error;\r\n      // تحديث\r\n      await loadResvsForDate(date);\r\n      window.alert('تم نقل الحجز بنجاح.');\r\n    } catch (e) {\r\n      console.error('move failed', e);\r\n      window.alert('تعذّر نقل الحجز: ' + (e.message || e));\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"p-8\" dir=\"rtl\">\r\n      <div className=\"flex items-center justify-between mb-6\">\r\n        <div>\r\n          <h2 className=\"text-2xl font-bold\">التسكين (عرض إشغال الأسِرّة)</h2>\r\n          <p className=\"text-sm text-gray-500\">عرض بصري لعدد الأسِرّة حسب سعة الغرفة وملؤها بالحجوزات الجارية في التاريخ المحدد.</p>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <input\r\n            type=\"date\"\r\n            className=\"border rounded px-3 py-2\"\r\n            value={date}\r\n            onChange={(e)=>setDate(e.target.value)}\r\n            title=\"اختر التاريخ\"\r\n          />\r\n          <button className=\"border rounded px-3 py-2 bg-white hover:bg-gray-50\" onClick={()=>setDate(new Date().toISOString().slice(0,10))}>اليوم</button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Help / legend */}\r\n      <div className=\"mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800\">\r\n        - اسحب بطاقة النزيل من غرفة إلى أخرى لنقل الحجز لنفس المدة. <br/>\r\n        - كل مستطيل صغير يمثل سريرًا؛ الممتلئ يعني مشغول حسب عدد الضيوف في الحجز. <br/>\r\n        - يمكنك تغيير التاريخ من الأعلى لمشاهدة إشغال يوم معين.\r\n      </div>\r\n\r\n      {loading ? (\r\n        <div className=\"text-gray-500\">جاري التحميل...</div>\r\n      ) : groups.length === 0 ? (\r\n        <div className=\"text-gray-500\">لا توجد غرف.</div>\r\n      ) : (\r\n        <div className=\"space-y-8\">\r\n          {groups.map((b, bi) => (\r\n            <div key={bi}>\r\n              <div className=\"text-lg font-bold text-gray-800 mb-3\">{b.label}</div>\r\n              <div className=\"space-y-6\">\r\n                {b.floors.map((f, fi) => (\r\n                  <div key={fi}>\r\n                    <div className=\"text-sm font-semibold text-gray-700 mb-2\">{f.label}</div>\r\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\r\n                      {f.rooms.map((room) => (\r\n                        <RoomTile\r\n                          key={room.id}\r\n                          room={room}\r\n                          resv={resvByRoom.get(String(room.id))}\r\n                          date={date}\r\n                          onDropReservation={onDropReservation}\r\n                        />\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
{"ast":null,"code":"import React,{useEffect,useMemo,useState,useCallback}from'react';import{supabase}from'../supabaseClient';import{getRoomStatusColor,getOccupancyColor}from'../utils/status';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";function StatusStrip(_ref){let{status}=_ref;const color=getRoomStatusColor(status);return/*#__PURE__*/_jsx(\"div\",{className:\"h-1\",style:{backgroundColor:color}});}function CleanBadge(_ref2){let{value}=_ref2;const map={clean:{text:'نظيفة',cls:'bg-green-100 text-green-700'},in_cleaning:{text:'جاري تنظيف',cls:'bg-amber-100 text-amber-700'},needs_cleaning:{text:'تحتاج نظافة',cls:'bg-red-100 text-red-700'}};const v=map[value]||map.clean;return/*#__PURE__*/_jsx(\"span\",{className:\"text-xs px-2 py-1 rounded \".concat(v.cls),children:v.text});}function RoomTile(_ref3){let{room,resv,date,onDropReservation}=_ref3;const capacity=Number(room.max_guests||room.capacity||0);const[beds,setBeds]=useState([]);const[loadingBeds,setLoadingBeds]=useState(false);const[resGuests,setResGuests]=useState([]);const[loadingGuests,setLoadingGuests]=useState(false);const[selectedGuestId,setSelectedGuestId]=useState(null);const[guestSearch,setGuestSearch]=useState('');const[guestResults,setGuestResults]=useState([]);const occupiedBeds=useMemo(()=>{if(!resv)return 0;const gc=Number(resv.guests_count||0);return Math.max(0,Math.min(gc,capacity||0));},[resv,capacity]);const loadBeds=useCallback(async()=>{try{setLoadingBeds(true);const{data,error}=await supabase.rpc('get_room_beds_status',{p_room_id:room.id,p_date:date});if(error)throw error;setBeds(data||[]);}catch(e){console.warn('get_room_beds_status failed, fallback to capacity squares',(e===null||e===void 0?void 0:e.message)||e);setBeds([]);}finally{setLoadingBeds(false);}},[room.id,date]);useEffect(()=>{loadBeds();},[loadBeds]);const loadReservationGuests=useCallback(async()=>{if(!resv||!resv.id){setResGuests([]);return;}try{setLoadingGuests(true);const{data,error}=await supabase.rpc('list_reservation_guests',{p_reservation_id:resv.id});if(error)throw error;setResGuests(data||[]);}catch(e){console.warn('list_reservation_guests failed',(e===null||e===void 0?void 0:e.message)||e);setResGuests([]);}finally{setLoadingGuests(false);}},[resv]);useEffect(()=>{loadReservationGuests();},[loadReservationGuests]);useEffect(()=>{const term=(guestSearch||'').trim();if(!term){setGuestResults([]);return;}const t=setTimeout(async()=>{try{const{data,error}=await supabase.from('guests').select('id, full_name, phone, email').or(\"full_name.ilike.%\".concat(term,\"%,phone.ilike.%\").concat(term,\"%,email.ilike.%\").concat(term,\"%\")).limit(10);if(error)throw error;setGuestResults(data||[]);}catch(e){console.warn('guest search failed',(e===null||e===void 0?void 0:e.message)||e);setGuestResults([]);}},350);return()=>clearTimeout(t);},[guestSearch]);const assignMainGuestToBed=async function(bed){let explicitGuestId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;try{if(!resv)return;const{error}=await supabase.rpc('assign_bed_for_reservation',{p_reservation_id:resv.id,p_room_bed_id:bed.bed_id,p_guest_id:explicitGuestId||selectedGuestId||resv.guest_id||null,p_start:resv.check_in_date,p_end:resv.check_out_date});if(error)throw error;await loadBeds();await loadReservationGuests();}catch(e){window.alert('تعذّر إسناد السرير: '+(e.message||e));}};const unassignBed=async assignmentId=>{try{const{error}=await supabase.rpc('unassign_bed',{p_assignment_id:assignmentId});if(error)throw error;await loadBeds();await loadReservationGuests();}catch(e){window.alert('تعذّر إلغاء إسناد السرير: '+(e.message||e));}};const addGuestToReservation=async guestId=>{try{if(!resv||!resv.id||!guestId)return;const{error}=await supabase.rpc('add_reservation_guest',{p_reservation_id:resv.id,p_guest_id:guestId,p_role:'additional'});if(error)throw error;setSelectedGuestId(guestId);setGuestSearch('');setGuestResults([]);await loadReservationGuests();await loadBeds();const empty=(beds||[]).find(b=>!b.assignment_id);if(empty){await assignMainGuestToBed(empty,guestId);}else{window.alert('لا توجد أسِرّة فارغة في هذه الغرفة لهذا اليوم.');}}catch(e){window.alert('تعذّر إضافة الضيف للحجز: '+(e.message||e));}};const handleDragOver=e=>{e.preventDefault();};const handleDrop=e=>{e.preventDefault();try{const payload=JSON.parse(e.dataTransfer.getData('application/json'));if(!payload||!payload.id)return;if(String(payload.room_id)===String(room.id))return;// نفس الغرفة لا حاجة للنقل\nonDropReservation&&onDropReservation(payload,room);}catch(_){}};const Beds=()=>{if(beds.length>0){return/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-wrap gap-2\",\"aria-label\":\"\\u0627\\u0644\\u0623\\u0633\\u0650\\u0631\\u0651\\u0629\",children:beds.map(b=>{const filled=!!b.assignment_id;return/*#__PURE__*/_jsxs(\"div\",{className:\"px-2 py-1 rounded border text-xs flex items-center gap-2 \".concat(filled?'bg-blue-50 text-blue-700':'bg-gray-50 text-gray-700'),style:{borderColor:getOccupancyColor(filled?'occupied':'empty')},title:filled?\"\\u0645\\u0634\\u063A\\u0648\\u0644: \".concat(b.guest_name||'—'):'فارغ',children:[/*#__PURE__*/_jsx(\"button\",{className:\"underline\",onClick:()=>{if(!filled&&resv)assignMainGuestToBed(b);},children:b.bed_code}),filled&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"span\",{children:[\"\\u2013 \",b.guest_name||'مجهول']}),/*#__PURE__*/_jsx(\"button\",{className:\"ml-2 text-red-600 hover:text-red-700\",title:\"\\u0625\\u0644\\u063A\\u0627\\u0621\",onClick:()=>unassignBed(b.assignment_id),children:\"\\u0625\\u0644\\u063A\\u0627\\u0621 \\u2716\"})]})]},b.bed_id);})});}const items=[];for(let i=0;i<(capacity||0);i++){const filled=i<occupiedBeds;items.push(/*#__PURE__*/_jsx(\"div\",{className:\"w-5 h-3 rounded-sm border\",style:{backgroundColor:getOccupancyColor(filled?'occupied':'empty'),borderColor:getOccupancyColor(filled?'occupied':'empty')},title:filled?'مشغول':'فارغ'},i));}return/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-wrap gap-1\",\"aria-label\":\"\\u0627\\u0644\\u0623\\u0633\\u0650\\u0631\\u0651\\u0629: \".concat(occupiedBeds,\"/\").concat(capacity),children:items});};return/*#__PURE__*/_jsxs(\"div\",{onDragOver:handleDragOver,onDrop:handleDrop,className:\"bg-white rounded-lg shadow border border-gray-200 overflow-hidden\",dir:\"rtl\",children:[/*#__PURE__*/_jsx(StatusStrip,{status:room.status}),/*#__PURE__*/_jsxs(\"div\",{className:\"p-3\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-2\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"font-bold text-gray-800\",title:\"\\u0627\\u0644\\u063A\\u0631\\u0641\\u0629\",children:room.room_code||room.room_label}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xs text-gray-500\",title:\"\\u0627\\u0644\\u0646\\u0648\\u0639\",children:room.room_type_name_ar||room.room_type_name})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-2 text-xs text-gray-600\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[room.floor_name,\" \\u2013 \",room.building_name]}),/*#__PURE__*/_jsx(CleanBadge,{value:room.cleanliness})]}),/*#__PURE__*/_jsx(\"div\",{className:\"mb-3\",children:/*#__PURE__*/_jsx(Beds,{})}),resv?/*#__PURE__*/_jsxs(\"div\",{draggable:true,onDragStart:e=>{e.dataTransfer.setData('application/json',JSON.stringify({id:resv.id,room_id:resv.room_id,check_in_date:resv.check_in_date,check_out_date:resv.check_out_date}));},className:\"px-2 py-1 rounded text-xs bg-blue-50 border border-blue-200 text-blue-700 cursor-grab\",title:\"\\u0627\\u0644\\u0646\\u0632\\u064A\\u0644: \".concat(resv.guest_name||'—'),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between gap-2\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"truncate\",children:resv.guest_name||'نزيل'}),/*#__PURE__*/_jsxs(\"span\",{className:\"text-[10px] text-gray-500\",children:[occupiedBeds,\"/\",capacity]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"text-[10px] text-gray-500\",children:[\"\\u0645\\u0646 \",resv.check_in_date,\" \\u0625\\u0644\\u0649 \",resv.check_out_date]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 p-2 bg-gray-50 border border-gray-200 rounded\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-xs font-semibold mb-1\",children:\"\\u0636\\u064A\\u0648\\u0641 \\u0627\\u0644\\u062D\\u062C\\u0632\"}),loadingGuests?/*#__PURE__*/_jsx(\"div\",{className:\"text-xs text-gray-500\",children:\"\\u062C\\u0627\\u0631\\u064A \\u0627\\u0644\\u062A\\u062D\\u0645\\u064A\\u0644...\"}):/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-wrap gap-2 mb-2\",children:resGuests.length===0?/*#__PURE__*/_jsx(\"span\",{className:\"text-xs text-gray-500\",children:\"\\u0644\\u0627 \\u064A\\u0648\\u062C\\u062F \\u0636\\u064A\\u0648\\u0641 \\u0625\\u0636\\u0627\\u0641\\u064A\\u0648\\u0646.\"}):resGuests.map(g=>/*#__PURE__*/_jsxs(\"label\",{className:\"px-2 py-1 rounded border text-xs cursor-pointer \".concat(selectedGuestId===g.guest_id?'bg-amber-50 border-amber-300 text-amber-800':'bg-white border-gray-300 text-gray-700'),children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",name:\"sel-\".concat(resv.id),className:\"mr-1\",checked:selectedGuestId===g.guest_id,onChange:()=>setSelectedGuestId(g.guest_id)}),g.full_name]},g.reservation_guest_id))}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center gap-2\",children:[/*#__PURE__*/_jsx(\"input\",{value:guestSearch,onChange:e=>setGuestSearch(e.target.value),className:\"border rounded px-2 py-1 text-xs flex-1\",placeholder:\"\\u0628\\u062D\\u062B: \\u0627\\u0644\\u0627\\u0633\\u0645/\\u0627\\u0644\\u0647\\u0627\\u062A\\u0641/\\u0627\\u0644\\u0628\\u0631\\u064A\\u062F\"}),guestResults.length>0&&/*#__PURE__*/_jsx(\"div\",{className:\"absolute mt-10 bg-white border rounded shadow p-2 text-xs max-h-40 overflow-auto z-10\",children:guestResults.map(gr=>/*#__PURE__*/_jsxs(\"div\",{className:\"px-2 py-1 hover:bg-gray-100 cursor-pointer\",onClick:()=>addGuestToReservation(gr.id),children:[gr.full_name,\" \",/*#__PURE__*/_jsxs(\"span\",{className:\"text-gray-500\",children:[\"(\",gr.phone||gr.email||gr.id.slice(0,8),\")\"]})]},gr.id))})]}),/*#__PURE__*/_jsx(\"div\",{className:\"mt-2 text-[11px] text-gray-500\",children:\"\\u0627\\u062E\\u062A\\u0631 \\u0636\\u064A\\u0641\\u064B\\u0627\\u060C \\u062B\\u0645 \\u0627\\u0636\\u063A\\u0637 \\u0639\\u0644\\u0649 \\u0633\\u0631\\u064A\\u0631 \\u0641\\u0627\\u0631\\u063A \\u0644\\u0625\\u0633\\u0646\\u0627\\u062F\\u0647.\"})]})]}):/*#__PURE__*/_jsx(\"div\",{className:\"text-xs text-gray-400\",children:\"\\u0644\\u0627 \\u064A\\u0648\\u062C\\u062F \\u062D\\u062C\\u0632 \\u0641\\u064A \\u0647\\u0630\\u0627 \\u0627\\u0644\\u062A\\u0627\\u0631\\u064A\\u062E\"})]})]});}export default function Tashkeen(_ref4){let{selectedDate,onDateChange,searchQuery='',refreshTick=0}=_ref4;const[date,setDate]=useState(()=>new Date().toISOString().slice(0,10));const[rooms,setRooms]=useState([]);const[resvs,setResvs]=useState([]);const[loading,setLoading]=useState(true);const loadRooms=useCallback(async()=>{// محاولة أولى: عرض rooms_overview إن وُجد\ntry{const{data,error}=await supabase.from('rooms_overview').select('id, room_code, room_label, status, cleanliness, max_guests, room_type_name_ar, room_type_name, building_id, building_name, floor_id, floor_name').order('room_code');if(error)throw error;if(data&&data.length>0){setRooms(data);return;}}catch(e){console.warn('rooms_overview unavailable, falling back to base tables:',(e===null||e===void 0?void 0:e.message)||e);}// بديل: الجداول الأساسية + عمليات إغناء عميلًا\ntry{const[roomsRes,typesRes,buildingsRes,floorsRes]=await Promise.all([supabase.from('rooms').select('id, room_code, status, cleanliness, room_type_id, building_id, floor_id').order('room_code'),supabase.from('room_types_active').select('id, name, name_ar, max_guests').order('display_order'),supabase.from('buildings').select('id, name').order('name'),supabase.from('floors').select('id, name, floor_number, number, building_id').order('id')]);// لو فشل room_types_active جرّب room_types العادية\nlet types=typesRes.data||[];if(typesRes.error||types.length===0){try{const alt=await supabase.from('room_types').select('id, name, name_ar, max_guests').order('id');if(!alt.error)types=alt.data||[];}catch(_){}}const typeMap=new Map();types.forEach(t=>typeMap.set(String(t.id),t));const bMap=new Map();(buildingsRes.data||[]).forEach(b=>bMap.set(String(b.id),b));const fMap=new Map();(floorsRes.data||[]).forEach(f=>fMap.set(String(f.id),f));const enriched=(roomsRes.data||[]).map(r=>{const t=typeMap.get(String(r.room_type_id));const b=bMap.get(String(r.building_id));const f=fMap.get(String(r.floor_id));const room_label=r.room_code||(r.id?\"\\u063A\\u0631\\u0641\\u0629 #\".concat(String(r.id).slice(0,8)):'غرفة');const building_name=(b===null||b===void 0?void 0:b.name)||'مبنى';const floor_name=(f===null||f===void 0?void 0:f.name)||(f!==null&&f!==void 0&&f.floor_number?\"\\u0627\\u0644\\u0637\\u0627\\u0628\\u0642 \".concat(f.floor_number):f!==null&&f!==void 0&&f.number?\"\\u0627\\u0644\\u0637\\u0627\\u0628\\u0642 \".concat(f.number):'طابق');return{id:r.id,room_code:r.room_code,room_label,status:r.status,cleanliness:r.cleanliness,max_guests:(t===null||t===void 0?void 0:t.max_guests)||0,room_type_name_ar:t===null||t===void 0?void 0:t.name_ar,room_type_name:t===null||t===void 0?void 0:t.name,building_id:r.building_id,building_name,floor_id:r.floor_id,floor_name};});setRooms(enriched);}catch(e2){console.error('Fallback loadRooms failed',e2);setRooms([]);}},[]);const loadResvsForDate=useCallback(async d=>{try{// الحجز الذي يغطي اليوم d: check_in <= d AND check_out >= d\nconst{data,error}=await supabase.from('reservations').select('id, room_id, guest_id, guests_count, status, check_in_date, check_out_date, guests(full_name)').in('status',['pending','confirmed','checked_in']).lte('check_in_date',d).gte('check_out_date',d);if(error)throw error;const mapped=(data||[]).map(r=>({id:r.id,room_id:r.room_id,guests_count:r.guests_count,status:r.status,check_in_date:r.check_in_date,check_out_date:r.check_out_date,guest_name:r.guests&&r.guests.full_name?r.guests.full_name:undefined}));setResvs(mapped);}catch(e){console.error('loadResvsForDate failed',e);setResvs([]);}},[]);const reloadAll=useCallback(async()=>{setLoading(true);await Promise.all([loadRooms(),loadResvsForDate(date)]);setLoading(false);},[date,loadRooms,loadResvsForDate]);useEffect(()=>{reloadAll();},[reloadAll]);// Sync external date\nuseEffect(()=>{if(selectedDate&&selectedDate!==date){setDate(selectedDate);}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[selectedDate]);// External refresh\nuseEffect(()=>{reloadAll();// eslint-disable-next-line react-hooks/exhaustive-deps\n},[refreshTick]);useEffect(()=>{const ch=supabase.channel('tashkeen-live').on('postgres_changes',{event:'*',schema:'public',table:'reservations'},()=>{loadResvsForDate(date);}).on('postgres_changes',{event:'*',schema:'public',table:'rooms'},()=>{loadRooms();}).subscribe();return()=>{try{supabase.removeChannel(ch);}catch(_){}};},[date,loadRooms,loadResvsForDate]);const resvByRoom=useMemo(()=>{const m=new Map();resvs.forEach(r=>{m.set(String(r.room_id),r);});return m;},[resvs]);const filteredRooms=useMemo(()=>{const term=(searchQuery||'').trim().toLowerCase();if(!term)return rooms;const resvByRoomLocal=new Map();resvs.forEach(r=>{resvByRoomLocal.set(String(r.room_id),r);});return rooms.filter(r=>{const roomMatch=(r.room_code||r.room_label||'').toLowerCase().includes(term);const rv=resvByRoomLocal.get(String(r.id));const guestMatch=rv?(rv.guest_name||'').toLowerCase().includes(term):false;return roomMatch||guestMatch;});},[rooms,resvs,searchQuery]);const groups=useMemo(()=>{// تجميع حسب المبنى ثم الطابق\nconst byBuilding=new Map();filteredRooms.forEach(r=>{const bKey=String(r.building_id||r.building_name||'—');const fKey=String(r.floor_id||r.floor_name||'—');if(!byBuilding.has(bKey))byBuilding.set(bKey,{label:r.building_name||'مبنى',floors:new Map()});const bObj=byBuilding.get(bKey);if(!bObj.floors.has(fKey))bObj.floors.set(fKey,{label:r.floor_name||'طابق',rooms:[]});bObj.floors.get(fKey).rooms.push(r);});// تحويل إلى مصفوفة قابلة للعرض\nreturn Array.from(byBuilding.values()).map(b=>({label:b.label,floors:Array.from(b.floors.values()).map(f=>({label:f.label,rooms:f.rooms}))}));},[filteredRooms]);const onDropReservation=async(payload,targetRoom)=>{try{const ok=window.confirm(\"\\u0646\\u0642\\u0644 \\u0627\\u0644\\u062D\\u062C\\u0632 \\u0625\\u0644\\u0649 \".concat(targetRoom.room_code||targetRoom.room_label,\" \\u0644\\u0646\\u0641\\u0633 \\u0627\\u0644\\u062A\\u0648\\u0627\\u0631\\u064A\\u062E\\u061F\"));if(!ok)return;const{data,error}=await supabase.rpc('move_reservation',{p_reservation_id:payload.id,p_new_room_id:targetRoom.id,p_new_check_in:payload.check_in_date,p_new_check_out:payload.check_out_date});if(error)throw error;// تحديث\nawait loadResvsForDate(date);window.alert('تم نقل الحجز بنجاح.');}catch(e){console.error('move failed',e);window.alert('تعذّر نقل الحجز: '+(e.message||e));}};return/*#__PURE__*/_jsxs(\"div\",{className:\"p-8\",dir:\"rtl\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-6\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h2\",{className:\"text-2xl font-bold\",children:\"\\u0627\\u0644\\u062A\\u0633\\u0643\\u064A\\u0646 (\\u0639\\u0631\\u0636 \\u0625\\u0634\\u063A\\u0627\\u0644 \\u0627\\u0644\\u0623\\u0633\\u0650\\u0631\\u0651\\u0629)\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-500\",children:\"\\u0639\\u0631\\u0636 \\u0628\\u0635\\u0631\\u064A \\u0644\\u0639\\u062F\\u062F \\u0627\\u0644\\u0623\\u0633\\u0650\\u0631\\u0651\\u0629 \\u062D\\u0633\\u0628 \\u0633\\u0639\\u0629 \\u0627\\u0644\\u063A\\u0631\\u0641\\u0629 \\u0648\\u0645\\u0644\\u0624\\u0647\\u0627 \\u0628\\u0627\\u0644\\u062D\\u062C\\u0648\\u0632\\u0627\\u062A \\u0627\\u0644\\u062C\\u0627\\u0631\\u064A\\u0629 \\u0641\\u064A \\u0627\\u0644\\u062A\\u0627\\u0631\\u064A\\u062E \\u0627\\u0644\\u0645\\u062D\\u062F\\u062F.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center gap-2\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"date\",className:\"border rounded px-3 py-2\",value:date,onChange:e=>{setDate(e.target.value);onDateChange&&onDateChange(e.target.value);},title:\"\\u0627\\u062E\\u062A\\u0631 \\u0627\\u0644\\u062A\\u0627\\u0631\\u064A\\u062E\"}),/*#__PURE__*/_jsx(\"button\",{className:\"border rounded px-3 py-2 bg-white hover:bg-gray-50\",onClick:()=>{const t=new Date().toISOString().slice(0,10);setDate(t);onDateChange&&onDateChange(t);},children:\"\\u0627\\u0644\\u064A\\u0648\\u0645\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800\",children:[\"- \\u0627\\u0633\\u062D\\u0628 \\u0628\\u0637\\u0627\\u0642\\u0629 \\u0627\\u0644\\u0646\\u0632\\u064A\\u0644 \\u0645\\u0646 \\u063A\\u0631\\u0641\\u0629 \\u0625\\u0644\\u0649 \\u0623\\u062E\\u0631\\u0649 \\u0644\\u0646\\u0642\\u0644 \\u0627\\u0644\\u062D\\u062C\\u0632 \\u0644\\u0646\\u0641\\u0633 \\u0627\\u0644\\u0645\\u062F\\u0629. \",/*#__PURE__*/_jsx(\"br\",{}),\"- \\u0643\\u0644 \\u0645\\u0633\\u062A\\u0637\\u064A\\u0644 \\u0635\\u063A\\u064A\\u0631 \\u064A\\u0645\\u062B\\u0644 \\u0633\\u0631\\u064A\\u0631\\u064B\\u0627\\u061B \\u0627\\u0644\\u0645\\u0645\\u062A\\u0644\\u0626 \\u064A\\u0639\\u0646\\u064A \\u0645\\u0634\\u063A\\u0648\\u0644 \\u062D\\u0633\\u0628 \\u0639\\u062F\\u062F \\u0627\\u0644\\u0636\\u064A\\u0648\\u0641 \\u0641\\u064A \\u0627\\u0644\\u062D\\u062C\\u0632. \",/*#__PURE__*/_jsx(\"br\",{}),\"- \\u064A\\u0645\\u0643\\u0646\\u0643 \\u062A\\u063A\\u064A\\u064A\\u0631 \\u0627\\u0644\\u062A\\u0627\\u0631\\u064A\\u062E \\u0645\\u0646 \\u0627\\u0644\\u0623\\u0639\\u0644\\u0649 \\u0644\\u0645\\u0634\\u0627\\u0647\\u062F\\u0629 \\u0625\\u0634\\u063A\\u0627\\u0644 \\u064A\\u0648\\u0645 \\u0645\\u0639\\u064A\\u0646.\",/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 text-xs text-blue-900 flex items-center gap-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center gap-2\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"inline-block w-4 h-4 rounded\",style:{backgroundColor:getOccupancyColor('occupied')}}),\" \",/*#__PURE__*/_jsx(\"span\",{children:\"\\u0633\\u0631\\u064A\\u0631 \\u0645\\u0634\\u063A\\u0648\\u0644\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center gap-2\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"inline-block w-4 h-4 rounded\",style:{backgroundColor:getOccupancyColor('empty')}}),\" \",/*#__PURE__*/_jsx(\"span\",{children:\"\\u0633\\u0631\\u064A\\u0631 \\u0641\\u0627\\u0631\\u063A\"})]})]})]}),loading?/*#__PURE__*/_jsx(\"div\",{className:\"text-gray-500\",children:\"\\u062C\\u0627\\u0631\\u064A \\u0627\\u0644\\u062A\\u062D\\u0645\\u064A\\u0644...\"}):groups.length===0?/*#__PURE__*/_jsx(\"div\",{className:\"text-gray-500\",children:\"\\u0644\\u0627 \\u062A\\u0648\\u062C\\u062F \\u063A\\u0631\\u0641.\"}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-8\",children:groups.map((b,bi)=>/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-lg font-bold text-gray-800 mb-3\",children:b.label}),/*#__PURE__*/_jsx(\"div\",{className:\"space-y-6\",children:b.floors.map((f,fi)=>/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-sm font-semibold text-gray-700 mb-2\",children:f.label}),/*#__PURE__*/_jsx(\"div\",{className:\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\",children:f.rooms.map(room=>/*#__PURE__*/_jsx(RoomTile,{room:room,resv:resvByRoom.get(String(room.id)),date:date,onDropReservation:onDropReservation},room.id))})]},fi))})]},bi))})]});}","map":{"version":3,"names":["React","useEffect","useMemo","useState","useCallback","supabase","getRoomStatusColor","getOccupancyColor","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","StatusStrip","_ref","status","color","className","style","backgroundColor","CleanBadge","_ref2","value","map","clean","text","cls","in_cleaning","needs_cleaning","v","concat","children","RoomTile","_ref3","room","resv","date","onDropReservation","capacity","Number","max_guests","beds","setBeds","loadingBeds","setLoadingBeds","resGuests","setResGuests","loadingGuests","setLoadingGuests","selectedGuestId","setSelectedGuestId","guestSearch","setGuestSearch","guestResults","setGuestResults","occupiedBeds","gc","guests_count","Math","max","min","loadBeds","data","error","rpc","p_room_id","id","p_date","e","console","warn","message","loadReservationGuests","p_reservation_id","term","trim","t","setTimeout","from","select","or","limit","clearTimeout","assignMainGuestToBed","bed","explicitGuestId","arguments","length","undefined","p_room_bed_id","bed_id","p_guest_id","guest_id","p_start","check_in_date","p_end","check_out_date","window","alert","unassignBed","assignmentId","p_assignment_id","addGuestToReservation","guestId","p_role","empty","find","b","assignment_id","handleDragOver","preventDefault","handleDrop","payload","JSON","parse","dataTransfer","getData","String","room_id","_","Beds","filled","borderColor","title","guest_name","onClick","bed_code","items","i","push","onDragOver","onDrop","dir","room_code","room_label","room_type_name_ar","room_type_name","floor_name","building_name","cleanliness","draggable","onDragStart","setData","stringify","g","type","name","checked","onChange","full_name","reservation_guest_id","target","placeholder","gr","phone","email","slice","Tashkeen","_ref4","selectedDate","onDateChange","searchQuery","refreshTick","setDate","Date","toISOString","rooms","setRooms","resvs","setResvs","loading","setLoading","loadRooms","order","roomsRes","typesRes","buildingsRes","floorsRes","Promise","all","types","alt","typeMap","Map","forEach","set","bMap","fMap","f","enriched","r","get","room_type_id","building_id","floor_id","floor_number","number","name_ar","e2","loadResvsForDate","d","in","lte","gte","mapped","guests","reloadAll","ch","channel","on","event","schema","table","subscribe","removeChannel","resvByRoom","m","filteredRooms","toLowerCase","resvByRoomLocal","filter","roomMatch","includes","rv","guestMatch","groups","byBuilding","bKey","fKey","has","label","floors","bObj","Array","values","targetRoom","ok","confirm","p_new_room_id","p_new_check_in","p_new_check_out","bi","fi"],"sources":["F:/kelany/src/pages/Tashkeen.jsx"],"sourcesContent":["import React, { useEffect, useMemo, useState, useCallback } from 'react';\r\nimport { supabase } from '../supabaseClient';\r\nimport { getRoomStatusColor, getOccupancyColor } from '../utils/status';\r\n\r\nfunction StatusStrip({ status }) {\r\n  const color = getRoomStatusColor(status);\r\n  return <div className=\"h-1\" style={{ backgroundColor: color }} />;\r\n}\r\n\r\nfunction CleanBadge({ value }) {\r\n  const map = {\r\n    clean: { text: 'نظيفة', cls: 'bg-green-100 text-green-700' },\r\n    in_cleaning: { text: 'جاري تنظيف', cls: 'bg-amber-100 text-amber-700' },\r\n    needs_cleaning: { text: 'تحتاج نظافة', cls: 'bg-red-100 text-red-700' },\r\n  };\r\n  const v = map[value] || map.clean;\r\n  return <span className={`text-xs px-2 py-1 rounded ${v.cls}`}>{v.text}</span>;\r\n}\r\n\r\nfunction RoomTile({ room, resv, date, onDropReservation }) {\r\n  const capacity = Number(room.max_guests || room.capacity || 0);\r\n  const [beds, setBeds] = useState([]);\r\n  const [loadingBeds, setLoadingBeds] = useState(false);\r\n  const [resGuests, setResGuests] = useState([]);\r\n  const [loadingGuests, setLoadingGuests] = useState(false);\r\n  const [selectedGuestId, setSelectedGuestId] = useState(null);\r\n  const [guestSearch, setGuestSearch] = useState('');\r\n  const [guestResults, setGuestResults] = useState([]);\r\n\r\n  const occupiedBeds = useMemo(() => {\r\n    if (!resv) return 0;\r\n    const gc = Number(resv.guests_count || 0);\r\n    return Math.max(0, Math.min(gc, capacity || 0));\r\n  }, [resv, capacity]);\r\n\r\n  const loadBeds = useCallback(async () => {\r\n    try {\r\n      setLoadingBeds(true);\r\n      const { data, error } = await supabase.rpc('get_room_beds_status', { p_room_id: room.id, p_date: date });\r\n      if (error) throw error;\r\n      setBeds(data || []);\r\n    } catch (e) {\r\n      console.warn('get_room_beds_status failed, fallback to capacity squares', e?.message || e);\r\n      setBeds([]);\r\n    } finally {\r\n      setLoadingBeds(false);\r\n    }\r\n  }, [room.id, date]);\r\n\r\n  useEffect(() => { loadBeds(); }, [loadBeds]);\r\n\r\n  const loadReservationGuests = useCallback(async () => {\r\n    if (!resv || !resv.id) { setResGuests([]); return; }\r\n    try {\r\n      setLoadingGuests(true);\r\n      const { data, error } = await supabase.rpc('list_reservation_guests', { p_reservation_id: resv.id });\r\n      if (error) throw error;\r\n      setResGuests(data || []);\r\n    } catch (e) {\r\n      console.warn('list_reservation_guests failed', e?.message || e);\r\n      setResGuests([]);\r\n    } finally {\r\n      setLoadingGuests(false);\r\n    }\r\n  }, [resv]);\r\n\r\n  useEffect(() => { loadReservationGuests(); }, [loadReservationGuests]);\r\n\r\n  useEffect(() => {\r\n    const term = (guestSearch || '').trim();\r\n    if (!term) { setGuestResults([]); return; }\r\n    const t = setTimeout(async () => {\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('guests')\r\n          .select('id, full_name, phone, email')\r\n          .or(`full_name.ilike.%${term}%,phone.ilike.%${term}%,email.ilike.%${term}%`)\r\n          .limit(10);\r\n        if (error) throw error;\r\n        setGuestResults(data || []);\r\n      } catch (e) {\r\n        console.warn('guest search failed', e?.message || e);\r\n        setGuestResults([]);\r\n      }\r\n    }, 350);\r\n    return () => clearTimeout(t);\r\n  }, [guestSearch]);\r\n\r\n  const assignMainGuestToBed = async (bed, explicitGuestId = null) => {\r\n    try {\r\n      if (!resv) return;\r\n      const { error } = await supabase.rpc('assign_bed_for_reservation', {\r\n        p_reservation_id: resv.id,\r\n        p_room_bed_id: bed.bed_id,\r\n        p_guest_id: explicitGuestId || selectedGuestId || resv.guest_id || null,\r\n        p_start: resv.check_in_date,\r\n        p_end: resv.check_out_date,\r\n      });\r\n      if (error) throw error;\r\n      await loadBeds();\r\n      await loadReservationGuests();\r\n    } catch (e) {\r\n      window.alert('تعذّر إسناد السرير: ' + (e.message || e));\r\n    }\r\n  };\r\n\r\n  const unassignBed = async (assignmentId) => {\r\n    try {\r\n      const { error } = await supabase.rpc('unassign_bed', { p_assignment_id: assignmentId });\r\n      if (error) throw error;\r\n      await loadBeds();\r\n      await loadReservationGuests();\r\n    } catch (e) {\r\n      window.alert('تعذّر إلغاء إسناد السرير: ' + (e.message || e));\r\n    }\r\n  };\r\n\r\n  const addGuestToReservation = async (guestId) => {\r\n    try {\r\n      if (!resv || !resv.id || !guestId) return;\r\n      const { error } = await supabase.rpc('add_reservation_guest', { p_reservation_id: resv.id, p_guest_id: guestId, p_role: 'additional' });\r\n      if (error) throw error;\r\n      setSelectedGuestId(guestId);\r\n      setGuestSearch('');\r\n      setGuestResults([]);\r\n      await loadReservationGuests();\r\n      await loadBeds();\r\n      const empty = (beds || []).find(b => !b.assignment_id);\r\n      if (empty) {\r\n        await assignMainGuestToBed(empty, guestId);\r\n      } else {\r\n        window.alert('لا توجد أسِرّة فارغة في هذه الغرفة لهذا اليوم.');\r\n      }\r\n    } catch (e) {\r\n      window.alert('تعذّر إضافة الضيف للحجز: ' + (e.message || e));\r\n    }\r\n  };\r\n\r\n  const handleDragOver = (e) => {\r\n    e.preventDefault();\r\n  };\r\n  const handleDrop = (e) => {\r\n    e.preventDefault();\r\n    try {\r\n      const payload = JSON.parse(e.dataTransfer.getData('application/json'));\r\n      if (!payload || !payload.id) return;\r\n      if (String(payload.room_id) === String(room.id)) return; // نفس الغرفة لا حاجة للنقل\r\n      onDropReservation && onDropReservation(payload, room);\r\n    } catch (_) {}\r\n  };\r\n\r\n  const Beds = () => {\r\n    if (beds.length > 0) {\r\n      return (\r\n        <div className=\"flex flex-wrap gap-2\" aria-label={`الأسِرّة`}>\r\n          {beds.map(b => {\r\n            const filled = !!b.assignment_id;\r\n            return (\r\n              <div\r\n                key={b.bed_id}\r\n                className={`px-2 py-1 rounded border text-xs flex items-center gap-2 ${filled ? 'bg-blue-50 text-blue-700' : 'bg-gray-50 text-gray-700'}`}\r\n                style={{ borderColor: getOccupancyColor(filled ? 'occupied' : 'empty') }}\r\n                title={filled ? `مشغول: ${b.guest_name || '—'}` : 'فارغ'}\r\n              >\r\n                <button className=\"underline\" onClick={() => { if (!filled && resv) assignMainGuestToBed(b); }}>\r\n                  {b.bed_code}\r\n                </button>\r\n                {filled && (\r\n                  <>\r\n                    <span>– {b.guest_name || 'مجهول'}</span>\r\n                    <button className=\"ml-2 text-red-600 hover:text-red-700\" title=\"إلغاء\" onClick={() => unassignBed(b.assignment_id)}>إلغاء ✖</button>\r\n                  </>\r\n                )}\r\n              </div>\r\n            );\r\n          })}\r\n        </div>\r\n      );\r\n    }\r\n    const items = [];\r\n    for (let i = 0; i < (capacity || 0); i++) {\r\n      const filled = i < occupiedBeds;\r\n      items.push(\r\n        <div key={i} className=\"w-5 h-3 rounded-sm border\" style={{ backgroundColor: getOccupancyColor(filled ? 'occupied' : 'empty'), borderColor: getOccupancyColor(filled ? 'occupied' : 'empty') }} title={filled ? 'مشغول' : 'فارغ'} />\r\n      );\r\n    }\r\n    return (\r\n      <div className=\"flex flex-wrap gap-1\" aria-label={`الأسِرّة: ${occupiedBeds}/${capacity}`}>\r\n        {items}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div onDragOver={handleDragOver} onDrop={handleDrop} className=\"bg-white rounded-lg shadow border border-gray-200 overflow-hidden\" dir=\"rtl\">\r\n      <StatusStrip status={room.status} />\r\n      <div className=\"p-3\">\r\n        <div className=\"flex items-center justify-between mb-2\">\r\n          <div className=\"font-bold text-gray-800\" title=\"الغرفة\">{room.room_code || room.room_label}</div>\r\n          <div className=\"text-xs text-gray-500\" title=\"النوع\">{room.room_type_name_ar || room.room_type_name}</div>\r\n        </div>\r\n        <div className=\"flex items-center justify-between mb-2 text-xs text-gray-600\">\r\n          <div>{room.floor_name} – {room.building_name}</div>\r\n          <CleanBadge value={room.cleanliness} />\r\n        </div>\r\n        <div className=\"mb-3\">\r\n          <Beds />\r\n        </div>\r\n        {resv ? (\r\n          <div\r\n            draggable\r\n            onDragStart={(e)=>{\r\n              e.dataTransfer.setData('application/json', JSON.stringify({\r\n                id: resv.id,\r\n                room_id: resv.room_id,\r\n                check_in_date: resv.check_in_date,\r\n                check_out_date: resv.check_out_date\r\n              }));\r\n            }}\r\n            className=\"px-2 py-1 rounded text-xs bg-blue-50 border border-blue-200 text-blue-700 cursor-grab\"\r\n            title={`النزيل: ${resv.guest_name || '—'}`}\r\n          >\r\n            <div className=\"flex items-center justify-between gap-2\">\r\n              <span className=\"truncate\">{resv.guest_name || 'نزيل'}</span>\r\n              <span className=\"text-[10px] text-gray-500\">{occupiedBeds}/{capacity}</span>\r\n            </div>\r\n            <div className=\"text-[10px] text-gray-500\">من {resv.check_in_date} إلى {resv.check_out_date}</div>\r\n            {/* Reservation guests panel */}\r\n            <div className=\"mt-2 p-2 bg-gray-50 border border-gray-200 rounded\">\r\n              <div className=\"text-xs font-semibold mb-1\">ضيوف الحجز</div>\r\n              {loadingGuests ? (\r\n                <div className=\"text-xs text-gray-500\">جاري التحميل...</div>\r\n              ) : (\r\n                <div className=\"flex flex-wrap gap-2 mb-2\">\r\n                  {resGuests.length === 0 ? (\r\n                    <span className=\"text-xs text-gray-500\">لا يوجد ضيوف إضافيون.</span>\r\n                  ) : resGuests.map(g => (\r\n                    <label key={g.reservation_guest_id} className={`px-2 py-1 rounded border text-xs cursor-pointer ${selectedGuestId===g.guest_id ? 'bg-amber-50 border-amber-300 text-amber-800' : 'bg-white border-gray-300 text-gray-700'}`}>\r\n                      <input type=\"radio\" name={`sel-${resv.id}`} className=\"mr-1\" checked={selectedGuestId===g.guest_id} onChange={()=>setSelectedGuestId(g.guest_id)} />\r\n                      {g.full_name}\r\n                    </label>\r\n                  ))}\r\n                </div>\r\n              )}\r\n              <div className=\"flex items-center gap-2\">\r\n                <input value={guestSearch} onChange={(e)=>setGuestSearch(e.target.value)} className=\"border rounded px-2 py-1 text-xs flex-1\" placeholder=\"بحث: الاسم/الهاتف/البريد\" />\r\n                {guestResults.length > 0 && (\r\n                  <div className=\"absolute mt-10 bg-white border rounded shadow p-2 text-xs max-h-40 overflow-auto z-10\">\r\n                    {guestResults.map(gr => (\r\n                      <div key={gr.id} className=\"px-2 py-1 hover:bg-gray-100 cursor-pointer\" onClick={()=>addGuestToReservation(gr.id)}>\r\n                        {gr.full_name} <span className=\"text-gray-500\">({gr.phone || gr.email || gr.id.slice(0,8)})</span>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </div>\r\n              <div className=\"mt-2 text-[11px] text-gray-500\">اختر ضيفًا، ثم اضغط على سرير فارغ لإسناده.</div>\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <div className=\"text-xs text-gray-400\">لا يوجد حجز في هذا التاريخ</div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function Tashkeen({ selectedDate, onDateChange, searchQuery = '', refreshTick = 0 }) {\r\n  const [date, setDate] = useState(() => new Date().toISOString().slice(0,10));\r\n  const [rooms, setRooms] = useState([]);\r\n  const [resvs, setResvs] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const loadRooms = useCallback(async () => {\r\n    // محاولة أولى: عرض rooms_overview إن وُجد\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('rooms_overview')\r\n        .select('id, room_code, room_label, status, cleanliness, max_guests, room_type_name_ar, room_type_name, building_id, building_name, floor_id, floor_name')\r\n        .order('room_code');\r\n      if (error) throw error;\r\n      if (data && data.length > 0) {\r\n        setRooms(data);\r\n        return;\r\n      }\r\n    } catch (e) {\r\n      console.warn('rooms_overview unavailable, falling back to base tables:', e?.message || e);\r\n    }\r\n\r\n    // بديل: الجداول الأساسية + عمليات إغناء عميلًا\r\n    try {\r\n      const [roomsRes, typesRes, buildingsRes, floorsRes] = await Promise.all([\r\n        supabase.from('rooms').select('id, room_code, status, cleanliness, room_type_id, building_id, floor_id').order('room_code'),\r\n        supabase.from('room_types_active').select('id, name, name_ar, max_guests').order('display_order'),\r\n        supabase.from('buildings').select('id, name').order('name'),\r\n        supabase.from('floors').select('id, name, floor_number, number, building_id').order('id'),\r\n      ]);\r\n\r\n      // لو فشل room_types_active جرّب room_types العادية\r\n      let types = typesRes.data || [];\r\n      if (typesRes.error || types.length === 0) {\r\n        try {\r\n          const alt = await supabase.from('room_types').select('id, name, name_ar, max_guests').order('id');\r\n          if (!alt.error) types = alt.data || [];\r\n        } catch (_) {}\r\n      }\r\n\r\n      const typeMap = new Map();\r\n      types.forEach(t => typeMap.set(String(t.id), t));\r\n      const bMap = new Map();\r\n      (buildingsRes.data || []).forEach(b => bMap.set(String(b.id), b));\r\n      const fMap = new Map();\r\n      (floorsRes.data || []).forEach(f => fMap.set(String(f.id), f));\r\n\r\n      const enriched = (roomsRes.data || []).map(r => {\r\n        const t = typeMap.get(String(r.room_type_id));\r\n        const b = bMap.get(String(r.building_id));\r\n        const f = fMap.get(String(r.floor_id));\r\n        const room_label = r.room_code || (r.id ? `غرفة #${String(r.id).slice(0,8)}` : 'غرفة');\r\n        const building_name = b?.name || 'مبنى';\r\n        const floor_name = f?.name || (f?.floor_number ? `الطابق ${f.floor_number}` : (f?.number ? `الطابق ${f.number}` : 'طابق'));\r\n        return {\r\n          id: r.id,\r\n          room_code: r.room_code,\r\n          room_label,\r\n          status: r.status,\r\n          cleanliness: r.cleanliness,\r\n          max_guests: t?.max_guests || 0,\r\n          room_type_name_ar: t?.name_ar,\r\n          room_type_name: t?.name,\r\n          building_id: r.building_id,\r\n          building_name,\r\n          floor_id: r.floor_id,\r\n          floor_name,\r\n        };\r\n      });\r\n      setRooms(enriched);\r\n    } catch (e2) {\r\n      console.error('Fallback loadRooms failed', e2);\r\n      setRooms([]);\r\n    }\r\n  }, []);\r\n\r\n  const loadResvsForDate = useCallback(async (d) => {\r\n    try {\r\n      // الحجز الذي يغطي اليوم d: check_in <= d AND check_out >= d\r\n      const { data, error } = await supabase\r\n        .from('reservations')\r\n        .select('id, room_id, guest_id, guests_count, status, check_in_date, check_out_date, guests(full_name)')\r\n        .in('status', ['pending','confirmed','checked_in'])\r\n        .lte('check_in_date', d)\r\n        .gte('check_out_date', d);\r\n      if (error) throw error;\r\n      const mapped = (data || []).map(r => ({\r\n        id: r.id,\r\n        room_id: r.room_id,\r\n        guests_count: r.guests_count,\r\n        status: r.status,\r\n        check_in_date: r.check_in_date,\r\n        check_out_date: r.check_out_date,\r\n        guest_name: (r.guests && r.guests.full_name) ? r.guests.full_name : undefined,\r\n      }));\r\n      setResvs(mapped);\r\n    } catch (e) {\r\n      console.error('loadResvsForDate failed', e);\r\n      setResvs([]);\r\n    }\r\n  }, []);\r\n\r\n  const reloadAll = useCallback(async () => {\r\n    setLoading(true);\r\n    await Promise.all([loadRooms(), loadResvsForDate(date)]);\r\n    setLoading(false);\r\n  }, [date, loadRooms, loadResvsForDate]);\r\n\r\n  useEffect(() => { reloadAll(); }, [reloadAll]);\r\n\r\n  // Sync external date\r\n  useEffect(() => {\r\n    if (selectedDate && selectedDate !== date) {\r\n      setDate(selectedDate);\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [selectedDate]);\r\n\r\n  // External refresh\r\n  useEffect(() => {\r\n    reloadAll();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [refreshTick]);\r\n\r\n  useEffect(() => {\r\n    const ch = supabase.channel('tashkeen-live')\r\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'reservations' }, () => { loadResvsForDate(date); })\r\n      .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, () => { loadRooms(); })\r\n      .subscribe();\r\n    return () => { try { supabase.removeChannel(ch); } catch(_) {} };\r\n  }, [date, loadRooms, loadResvsForDate]);\r\n\r\n  const resvByRoom = useMemo(() => {\r\n    const m = new Map();\r\n    resvs.forEach(r => { m.set(String(r.room_id), r); });\r\n    return m;\r\n  }, [resvs]);\r\n\r\n  const filteredRooms = useMemo(() => {\r\n    const term = (searchQuery || '').trim().toLowerCase();\r\n    if (!term) return rooms;\r\n    const resvByRoomLocal = new Map();\r\n    resvs.forEach(r => { resvByRoomLocal.set(String(r.room_id), r); });\r\n    return rooms.filter(r => {\r\n      const roomMatch = (r.room_code || r.room_label || '').toLowerCase().includes(term);\r\n      const rv = resvByRoomLocal.get(String(r.id));\r\n      const guestMatch = rv ? ((rv.guest_name || '').toLowerCase().includes(term)) : false;\r\n      return roomMatch || guestMatch;\r\n    });\r\n  }, [rooms, resvs, searchQuery]);\r\n\r\n  const groups = useMemo(() => {\r\n    // تجميع حسب المبنى ثم الطابق\r\n    const byBuilding = new Map();\r\n    filteredRooms.forEach(r => {\r\n      const bKey = String(r.building_id || r.building_name || '—');\r\n      const fKey = String(r.floor_id || r.floor_name || '—');\r\n      if (!byBuilding.has(bKey)) byBuilding.set(bKey, { label: r.building_name || 'مبنى', floors: new Map() });\r\n      const bObj = byBuilding.get(bKey);\r\n      if (!bObj.floors.has(fKey)) bObj.floors.set(fKey, { label: r.floor_name || 'طابق', rooms: [] });\r\n      bObj.floors.get(fKey).rooms.push(r);\r\n    });\r\n    // تحويل إلى مصفوفة قابلة للعرض\r\n    return Array.from(byBuilding.values()).map(b => ({\r\n      label: b.label,\r\n      floors: Array.from(b.floors.values()).map(f => ({ label: f.label, rooms: f.rooms }))\r\n    }));\r\n  }, [filteredRooms]);\r\n\r\n  const onDropReservation = async (payload, targetRoom) => {\r\n    try {\r\n      const ok = window.confirm(`نقل الحجز إلى ${targetRoom.room_code || targetRoom.room_label} لنفس التواريخ؟`);\r\n      if (!ok) return;\r\n      const { data, error } = await supabase.rpc('move_reservation', {\r\n        p_reservation_id: payload.id,\r\n        p_new_room_id: targetRoom.id,\r\n        p_new_check_in: payload.check_in_date,\r\n        p_new_check_out: payload.check_out_date,\r\n      });\r\n      if (error) throw error;\r\n      // تحديث\r\n      await loadResvsForDate(date);\r\n      window.alert('تم نقل الحجز بنجاح.');\r\n    } catch (e) {\r\n      console.error('move failed', e);\r\n      window.alert('تعذّر نقل الحجز: ' + (e.message || e));\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"p-8\" dir=\"rtl\">\r\n      <div className=\"flex items-center justify-between mb-6\">\r\n        <div>\r\n          <h2 className=\"text-2xl font-bold\">التسكين (عرض إشغال الأسِرّة)</h2>\r\n          <p className=\"text-sm text-gray-500\">عرض بصري لعدد الأسِرّة حسب سعة الغرفة وملؤها بالحجوزات الجارية في التاريخ المحدد.</p>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <input\r\n            type=\"date\"\r\n            className=\"border rounded px-3 py-2\"\r\n            value={date}\r\n            onChange={(e)=>{ setDate(e.target.value); onDateChange && onDateChange(e.target.value); }}\r\n            title=\"اختر التاريخ\"\r\n          />\r\n          <button className=\"border rounded px-3 py-2 bg-white hover:bg-gray-50\" onClick={()=>{ const t = new Date().toISOString().slice(0,10); setDate(t); onDateChange && onDateChange(t); }}>اليوم</button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Help / legend */}\r\n      <div className=\"mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800\">\r\n        - اسحب بطاقة النزيل من غرفة إلى أخرى لنقل الحجز لنفس المدة. <br/>\r\n        - كل مستطيل صغير يمثل سريرًا؛ الممتلئ يعني مشغول حسب عدد الضيوف في الحجز. <br/>\r\n        - يمكنك تغيير التاريخ من الأعلى لمشاهدة إشغال يوم معين.\r\n        <div className=\"mt-2 text-xs text-blue-900 flex items-center gap-4\">\r\n          <div className=\"flex items-center gap-2\"><span className=\"inline-block w-4 h-4 rounded\" style={{ backgroundColor: getOccupancyColor('occupied') }}></span> <span>سرير مشغول</span></div>\r\n          <div className=\"flex items-center gap-2\"><span className=\"inline-block w-4 h-4 rounded\" style={{ backgroundColor: getOccupancyColor('empty') }}></span> <span>سرير فارغ</span></div>\r\n        </div>\r\n      </div>\r\n\r\n      {loading ? (\r\n        <div className=\"text-gray-500\">جاري التحميل...</div>\r\n      ) : groups.length === 0 ? (\r\n        <div className=\"text-gray-500\">لا توجد غرف.</div>\r\n      ) : (\r\n        <div className=\"space-y-8\">\r\n          {groups.map((b, bi) => (\r\n            <div key={bi}>\r\n              <div className=\"text-lg font-bold text-gray-800 mb-3\">{b.label}</div>\r\n              <div className=\"space-y-6\">\r\n                {b.floors.map((f, fi) => (\r\n                  <div key={fi}>\r\n                    <div className=\"text-sm font-semibold text-gray-700 mb-2\">{f.label}</div>\r\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\r\n                      {f.rooms.map((room) => (\r\n                        <RoomTile\r\n                          key={room.id}\r\n                          room={room}\r\n                          resv={resvByRoom.get(String(room.id))}\r\n                          date={date}\r\n                          onDropReservation={onDropReservation}\r\n                        />\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}